<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>第 2 章 Kubernetes</title><link rel="stylesheet" type="text/css" href="..//docbook.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><meta name="keywords" content="qmeu,kvm,xen,openvz, docker, coreos, , " /><link rel="home" href="../index.html" title="Netkiller Virtualization 手札" /><link rel="up" href="../index.html" title="Netkiller Virtualization 手札" /><link rel="prev" href="../docker/docker.example.html" title="1.11. Docker Example" /><link rel="next" href="kubectl.html" title="2.2. kubectl - controls the Kubernetes cluster manager." /></head><body><a xmlns="" href="//www.netkiller.cn/">Home</a> |
		<a xmlns="" href="//netkiller.github.io/">简体中文</a> |
	    <a xmlns="" href="http://netkiller.sourceforge.net/">繁体中文</a> |
	    <a xmlns="" href="/journal/index.html">杂文</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/donations.html">打赏(Donations)</a> |
	    <a xmlns="" href="https://github.com/netkiller">Github</a> |
	    <a xmlns="" href="http://my.oschina.net/neochen/">OSChina 博客</a> |
	    <a xmlns="" href="https://cloud.tencent.com/developer/column/2078">云社区</a> |
	    <a xmlns="" href="https://yq.aliyun.com/u/netkiller/">云栖社区</a> |
	    <a xmlns="" href="https://www.facebook.com/bg7nyt">Facebook</a> |
	    <a xmlns="" href="http://cn.linkedin.com/in/netkiller/">Linkedin</a> |
	    <a xmlns="" href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/video.html">视频教程</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/about.html">About</a><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第 2 章 Kubernetes</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="../docker/docker.example.html">上一页</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="kubectl.html">下一页</a></td></tr></table><hr /></div><table xmlns=""><tr><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=watch&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=fork&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;type=follow&amp;count=true&amp;size=large" height="30" width="240" frameborder="0" scrolling="0" style="width:240px; height: 30px;" allowTransparency="true"></iframe></td></tr></table><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="index"></a>第 2 章 Kubernetes</h1></div></div></div><div class="toc"><p><strong>目录</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#minikube">2.1. Minikube</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#minikube.install">2.1.1. 安装 </a></span></dt><dd><dl><dt><span class="section"><a href="index.html#idp60">2.1.1.1. BIOS 设置</a></span></dt><dt><span class="section"><a href="index.html#idp61">2.1.1.2. CentOS</a></span></dt><dt><span class="section"><a href="index.html#microk8s">2.1.1.3. Ubuntu</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#Quickstart">2.1.2. Quickstart</a></span></dt><dt><span class="section"><a href="index.html#minikube.command">2.1.3. minikube 命令</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#idp66">2.1.3.1. 启动 minikube</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#idp62">2.1.3.1.1. 虚拟机驱动</a></span></dt><dt><span class="section"><a href="index.html#idp63">2.1.3.1.2. 指定 registry-mirror 镜像</a></span></dt><dt><span class="section"><a href="index.html#idp64">2.1.3.1.3. 开启 </a></span></dt><dt><span class="section"><a href="index.html#idp65">2.1.3.1.4. 日志输出级别</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#idp67">2.1.3.2. 缓存镜像</a></span></dt><dt><span class="section"><a href="index.html#idp68">2.1.3.3. 清理 minikube</a></span></dt><dt><span class="section"><a href="index.html#idp69">2.1.3.4. Kubernetes 控制面板</a></span></dt><dt><span class="section"><a href="index.html#idp70">2.1.3.5. service</a></span></dt><dt><span class="section"><a href="index.html#idp71">2.1.3.6. 查看日志</a></span></dt><dt><span class="section"><a href="index.html#idp72">2.1.3.7. 查看 Docker 环境变量</a></span></dt><dt><span class="section"><a href="index.html#idp73">2.1.3.8. addons</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#idp77">2.1.4. FAQ</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#idp74">2.1.4.1. This computer doesn't have VT-X/AMD-v enabled. Enabling it in the BIOS is mandatory</a></span></dt><dt><span class="section"><a href="index.html#idp75">2.1.4.2. ERROR FileContent--proc-sys-net-bridge-bridge-nf-call-iptables</a></span></dt><dt><span class="section"><a href="index.html#idp76">2.1.4.3. ERROR ImagePull</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="kubectl.html">2.2. kubectl - controls the Kubernetes cluster manager. </a></span></dt><dd><dl><dt><span class="section"><a href="kubectl.html#idp78">2.2.1. 节点</a></span></dt><dt><span class="section"><a href="kubectl.html#get.pod">2.2.2. pod</a></span></dt><dt><span class="section"><a href="kubectl.html#get.pods">2.2.3. pods</a></span></dt><dt><span class="section"><a href="kubectl.html#get.cs">2.2.4. 查询集群状态</a></span></dt><dt><span class="section"><a href="kubectl.html#cluster-info">2.2.5. cluster-info</a></span></dt><dt><span class="section"><a href="kubectl.html#kubectl.create">2.2.6. create</a></span></dt><dt><span class="section"><a href="kubectl.html#kubectl.edit">2.2.7. edit</a></span></dt><dt><span class="section"><a href="kubectl.html#kubectl.config">2.2.8. config</a></span></dt><dt><span class="section"><a href="kubectl.html#get.nodes">2.2.9. nodes</a></span></dt><dt><span class="section"><a href="kubectl.html#get.service">2.2.10. service</a></span></dt><dd><dl><dt><span class="section"><a href="kubectl.html#idp79">2.2.10.1. 列出服务</a></span></dt><dt><span class="section"><a href="kubectl.html#idp80">2.2.10.2. 删除服务</a></span></dt><dt><span class="section"><a href="kubectl.html#idp81">2.2.10.3. 删除 pod</a></span></dt></dl></dd></dl></dd></dl></div>
	
	
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="minikube"></a>2.1. Minikube</h2></div></div></div>
	
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="minikube.install"></a>2.1.1. 安装 </h3></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp60"></a>2.1.1.1. BIOS 设置</h4></div></div></div>
			
			<p>执行下面命令检查服务器是否开启虚拟化技术</p>
			<pre class="screen">
			
egrep --color 'vmx|svm' /proc/cpuinfo			
			
			</pre>
			<p>如果没有任何输出，请重启服务器进入 BIOS 启用 VT-X 或 AMD-v</p>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp61"></a>2.1.1.2. CentOS</h4></div></div></div>
			
			<pre class="screen">
			
curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/v1.13.2/bin/linux/amd64/kubectl &amp;&amp; chmod +x kubectl &amp;&amp; sudo cp kubectl /usr/local/bin/ &amp;&amp; rm kubectl			
			
			</pre>
			<pre class="screen">
			
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 \
  &amp;&amp; install minikube-linux-amd64 /usr/local/bin/minikube			
			
			</pre>
			<p>尝试运行 minikube 如果输出帮助信息表示安装成功</p>
			<pre class="screen">
			
minikube version
minikube version: v0.33.1			
			
			</pre>
			<p></p>
			<pre class="screen">
			
echo "1" &gt; /proc/sys/net/bridge/bridge-nf-call-iptables			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="microk8s"></a>2.1.1.3. Ubuntu</h4></div></div></div>
			
			<pre class="screen">
			
snap install kubectl --classic			
snap install microk8s --channel=1.14/beta --classic	
			
			</pre>
			<p>安装 VirtualBox</p>
			<pre class="screen">
			
neo@ubuntu:~$ sudo apt install -y virtualbox			
			
			</pre>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Quickstart"></a>2.1.2. Quickstart</h3></div></div></div>
		
		<p>启动</p>
		<pre class="screen">
		
minikube start
		
		</pre>
		<p>运行一个 echoserver 镜像</p>
		<pre class="screen">
		
kubectl run hello-minikube --image=k8s.gcr.io/echoserver:1.4 --port=8080
kubectl expose deployment hello-minikube --type=NodePort
minikube service hello-minikube
		
		</pre>
		<p>查询 echoserver 访问地址</p>
		<pre class="screen">
		
minikube service hello-minikube --url		
		
		</pre>
		<p>在浏览器中访问查询到的网址</p>
		<p>停止并删除镜像</p>
		<pre class="screen">
		
minikube stop
minikube delete		
		
		</pre>
		<div class="example"><a id="idp89"></a><p class="title"><strong>例 2.1. minikube 操作演示</strong></p><div class="example-contents">
			
			<p>快速开始使用 minikube 运行一个镜像</p>
			<pre class="screen">
			
[root@localhost ~]# kubectl run hello-minikube --image=k8s.gcr.io/echoserver:1.4 --port=8080
kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.
deployment.apps/hello-minikube created

[root@localhost ~]# kubectl expose deployment hello-minikube --type=NodePort
service/hello-minikube exposed

[root@localhost ~]# minikube service hello-minikube
Opening kubernetes service default/hello-minikube in default browser...		

[root@localhost ~]# kubectl get pod
NAME                              READY   STATUS    RESTARTS   AGE
hello-minikube-5c856cbf98-6vfvp   1/1     Running   0          6m59s

[root@localhost ~]# minikube service hello-minikube --url
http://172.16.0.121:30436

[root@localhost ~]# curl http://172.16.0.121:30436
CLIENT VALUES:
client_address=172.17.0.1
command=GET
real path=/
query=nil
request_version=1.1
request_uri=http://172.16.0.121:8080/

SERVER VALUES:
server_version=nginx: 1.10.0 - lua: 10001

HEADERS RECEIVED:
accept=*/*
host=172.16.0.121:30436
user-agent=curl/7.29.0
BODY:
-no body in request-
			
			</pre>
		</div></div><br class="example-break" />
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="minikube.command"></a>2.1.3. minikube 命令</h3></div></div></div>
		
		<pre class="screen">
			
[root@localhost ~]# minikube
Minikube is a CLI tool that provisions and manages single-node Kubernetes clusters optimized for development workflows.

Usage:
  minikube [command]

Available Commands:
  addons         Modify minikube's kubernetes addons
  cache          Add or delete an image from the local cache.
  completion     Outputs minikube shell completion for the given shell (bash or zsh)
  config         Modify minikube config
  dashboard      Access the kubernetes dashboard running within the minikube cluster
  delete         Deletes a local kubernetes cluster
  docker-env     Sets up docker env variables; similar to '$(docker-machine env)'
  help           Help about any command
  ip             Retrieves the IP address of the running cluster
  logs           Gets the logs of the running instance, used for debugging minikube, not user code
  mount          Mounts the specified directory into minikube
  profile        Profile sets the current minikube profile
  service        Gets the kubernetes URL(s) for the specified service in your local cluster
  ssh            Log into or run a command on a machine with SSH; similar to 'docker-machine ssh'
  ssh-key        Retrieve the ssh identity key path of the specified cluster
  start          Starts a local kubernetes cluster
  status         Gets the status of a local kubernetes cluster
  stop           Stops a running local kubernetes cluster
  tunnel         tunnel makes services of type LoadBalancer accessible on localhost
  update-check   Print current and latest version number
  update-context Verify the IP address of the running cluster in kubeconfig.
  version        Print the version of minikube

Flags:
      --alsologtostderr                  log to standard error as well as files
  -b, --bootstrapper string              The name of the cluster bootstrapper that will set up the kubernetes cluster. (default "kubeadm")
  -h, --help                             help for minikube
      --log_backtrace_at traceLocation   when logging hits line file:N, emit a stack trace (default :0)
      --log_dir string                   If non-empty, write log files in this directory
      --logtostderr                      log to standard error instead of files
  -p, --profile string                   The name of the minikube VM being used.  
                                         	This can be modified to allow for multiple minikube instances to be run independently (default "minikube")
      --stderrthreshold severity         logs at or above this threshold go to stderr (default 2)
  -v, --v Level                          log level for V logs
      --vmodule moduleSpec               comma-separated list of pattern=N settings for file-filtered logging

Use "minikube [command] --help" for more information about a command.			
			
			</pre>
		
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp66"></a>2.1.3.1. 启动 minikube</h4></div></div></div>
			
			<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp62"></a>2.1.3.1.1. 虚拟机驱动</h5></div></div></div>
				
				<p>--vm-driver=none</p>
				<pre class="screen">
				
minikube start --vm-driver=none
				
				</pre>
			</div>
			<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp63"></a>2.1.3.1.2. 指定 registry-mirror 镜像</h5></div></div></div>
				
				<pre class="screen">
				
minikube start --registry-mirror=https://registry.docker-cn.com
				
				</pre>
			</div>
			<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp64"></a>2.1.3.1.3. 开启 </h5></div></div></div>
				
				<pre class="screen">
				
minikube start --vm-driver kvm2 --gpu				
				
				</pre>
			</div>
			<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp65"></a>2.1.3.1.4. 日志输出级别</h5></div></div></div>
				
				<p>指定日志输出级别</p>
				<pre class="screen">
				
minikube start --v=7			
				
				</pre>
			</div>
			
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp67"></a>2.1.3.2. 缓存镜像</h4></div></div></div>
			
			<pre class="screen">
			
# cache a image into $HOME/.minikube/cache/images
$ minikube cache add ubuntu:16.04
$ minikube cache add redis:3

# list cached images
$ minikube cache list
redis:3
ubuntu:16.04

# delete cached images
$ minikube cache delete ubuntu:16.04
$ minikube cache delete $(minikube cache list)
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp68"></a>2.1.3.3. 清理 minikube</h4></div></div></div>
			
			<pre class="screen">
			
minikube delete
rm ~/.minikube 
minikube start
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp69"></a>2.1.3.4. Kubernetes 控制面板</h4></div></div></div>
			
			<p>Dashboard是基于Web的Kubernetes管理界面。使用下面的命令启动：</p>
			<pre class="screen">
			
minikube dashboard
			
			</pre>
			<p>查询控制面板访问地址</p>
			<pre class="screen">
			
$ minikube dashboard --url
http://192.168.3.14:30000			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp70"></a>2.1.3.5. service</h4></div></div></div>
			
			<p></p>
			<pre class="screen">
			
[root@localhost ~]# minikube service hello-minikube --url
http://172.16.0.121:30436			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp71"></a>2.1.3.6. 查看日志</h4></div></div></div>
			
			<pre class="screen">
			
minikube logs -v10			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp72"></a>2.1.3.7. 查看 Docker 环境变量</h4></div></div></div>
			
			<pre class="screen">
			
minikube docker-env
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp73"></a>2.1.3.8. addons</h4></div></div></div>
			
			<pre class="screen">
			
[root@localhost ~]# minikube addons list
- addon-manager: enabled
- dashboard: enabled
- default-storageclass: enabled
- efk: disabled
- freshpod: disabled
- gvisor: disabled
- heapster: disabled
- ingress: disabled
- kube-dns: disabled
- metrics-server: disabled
- nvidia-driver-installer: disabled
- nvidia-gpu-device-plugin: disabled
- registry: disabled
- registry-creds: disabled
- storage-provisioner: enabled
- storage-provisioner-gluster: disabled			
			
			</pre>
		</div>
		
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idp77"></a>2.1.4. FAQ</h3></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp74"></a>2.1.4.1. This computer doesn't have VT-X/AMD-v enabled. Enabling it in the BIOS is mandatory</h4></div></div></div>
			
			<p>检查一下 BIOS 是否开启 VT-X/AMD-v</p>
			<p>如果在虚拟机安装 Minikube 也会遇到这个问题。 可以使用 --vm-driver=none 参数启动。</p>
			<pre class="screen">
			
neo@ubuntu:~$ sudo minikube start --vm-driver=none
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp75"></a>2.1.4.2. ERROR FileContent--proc-sys-net-bridge-bridge-nf-call-iptables</h4></div></div></div>
			
			<p>解决方法</p>
			<pre class="screen">
			
echo "1" &gt; /proc/sys/net/bridge/bridge-nf-call-iptables
			
			</pre>
			<p>然后在 minikube start</p>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp76"></a>2.1.4.3. ERROR ImagePull</h4></div></div></div>
			
			<p>[ERROR ImagePull]: failed to pull image k8s.gcr.io/pause:3.1: output: 3.1: Pulling from pause
Get https://k8s.gcr.io/v2/pause/manifests/sha256:59eec8837a4d942cc19a52b8c09ea75121acc38114a2c68b98983ce9356b8610: net/http: TLS handshake timeout</p>
			<p>更换镜像再重试</p>
			<pre class="screen">
			
[root@localhost ~]# minikube start --vm-driver=none --registry-mirror=https://registry.docker-cn.com			
			
			</pre>
		</div>
	</div>
</div>
	



</div><div xmlns="" id="disqus_thread"></div><script xmlns="">

var disqus_config = function () {
this.page.url = "http://www.netkiller.cn";  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = 'netkiller'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//netkiller.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script><noscript xmlns="">Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><br xmlns="" /><script xmlns="" type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=r5HG&amp;d=9mi5r_kkDC8uxG8HuY3p4-2qgeeVypAK9vMD-2P6BYM"></script><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="../docker/docker.example.html">上一页</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="kubectl.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">1.11. Docker Example </td><td width="20%" align="center"><a accesskey="h" href="../index.html">起始页</a></td><td width="40%" align="right" valign="top"> 2.2. kubectl - controls the Kubernetes cluster manager. </td></tr></table></div><script xmlns="">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-11694057-1', 'auto');
  ga('send', 'pageview');

</script><script xmlns="" async="async">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?93967759a51cda79e49bf4e34d0b0f2c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script xmlns="" async="async">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script><script xmlns="" type="text/javascript" src="/js/q.js" async="async"></script></body></html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>9.3. Socket</title><meta name="generator" content="DocBook XSL Stylesheets V1.76.1"><meta name="keywords" content="php, pear, pecl, phar"><link rel="home" href="index.html" title="Netkiller Python 手札"><link rel="up" href="ch09.html" title="第 9 章 Library"><link rel="prev" href="ch09s02.html" title="9.2. syslog"><link rel="next" href="ch09s04.html" title="9.4. Daemon"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="section" title="9.3. Socket"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp287568"></a>9.3. Socket</h2></div></div></div>
	
	<div class="section" title="9.3.1. UDP"><div class="titlepage"><div><div><h3 class="title"><a name="idp288272"></a>9.3.1. UDP</h3></div></div></div>
		
		<div class="section" title="9.3.1.1. UDP Server"><div class="titlepage"><div><div><h4 class="title"><a name="idp289072"></a>9.3.1.1. UDP Server</h4></div></div></div>
			
			<pre class="programlisting">
			
import asyncore, socket 

class AsyncoreServerUDP(asyncore.dispatcher): 
   def __init__(self): 
      asyncore.dispatcher.__init__(self) 

      # Bind to port 5005 on all interfaces 
      self.create_socket(socket.AF_INET, socket.SOCK_DGRAM) 
      self.bind(('', 5005)) 

   # Even though UDP is connectionless this is called when it binds to a port 
   def handle_connect(self): 
      print "Server Started..." 

   # This is called everytime there is something to read 
   def handle_read(self): 
      data, addr = self.recvfrom(2048) 
      print str(addr)+" &gt;&gt; "+data 

   # This is called all the time and causes errors if you leave it out. 
   def handle_write(self): 
      pass 

AsyncoreServerUDP() 
asyncore.loop()
			
			</pre>
		</div>
		<div class="section" title="9.3.1.2. UDP Clinet"><div class="titlepage"><div><div><h4 class="title"><a name="idp291680"></a>9.3.1.2. UDP Clinet</h4></div></div></div>
			
			<pre class="programlisting">
			
import socket, asyncore 

class AsyncoreClientUDP(asyncore.dispatcher): 

   def __init__(self, server, port): 
      asyncore.dispatcher.__init__(self) 
      self.server = server 
      self.port = port 
      self.buffer = "" 

      # Network Connection Magic! 
      asyncore.dispatcher.__init__(self) 
      self.create_socket(socket.AF_INET, socket.SOCK_DGRAM) 
      self.bind( ('', 0) ) # bind to all interfaces and a "random" free port. 
      print "Connecting..." 

   # Once a "connection" is made do this stuff. 
   def handle_connect(self): 
      print "Connected" 
    
   # If a "connection" is closed do this stuff. 
   def handle_close(self): 
      self.close() 

   # If a message has arrived, process it. 
   def handle_read(self): 
      data, addr = self.recv(2048) 
      print data 

   # Actually sends the message if there was something in the buffer. 
   def handle_write(self): 
      if self.buffer != "": 
         print self.buffer 
         sent = self.sendto(self.buffer, (self.server, self.port)) 
         self.buffer = self.buffer[sent:] 

connection = AsyncoreClientUDP("127.0.0.1",5005) # create the "connection" 
while 1: 
   asyncore.loop(count = 10) # Check for upto 10 packets this call? 
   connection.buffer += raw_input(" Chat &gt; ") # raw_input (this is a blocking call)
			
			</pre>
		</div>		
	</div>
</div></body></html>

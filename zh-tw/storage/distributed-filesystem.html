<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>第 6 章 Distributed Filesystem</title><link rel="stylesheet" type="text/css" href="/docbook.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.76.1" /><meta name="keywords" content="openfiler, freenas, proftpd,pureftpd,vsftpd, rsync,wget,samba" /><link rel="home" href="index.html" title="Netkiller Linux Storage 手札" /><link rel="up" href="index.html" title="Netkiller Linux Storage 手札" /><link rel="prev" href="samba.html" title="2. Samba" /><link rel="next" href="nbd.html" title="2. Network Block Device protocol" /><script xmlns="" type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11694057-1']);
  _gaq.push(['_setDomainName', 'netkiller.sourceforge.net']);
  _gaq.push(['_setAllowHash', 'false']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第 6 章 Distributed Filesystem</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="samba.html">上一頁</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="nbd.html">下一頁</a></td></tr></table><hr /></div><table xmlns="" width="100%" border="0"><tr><td align="left"><a href="http://netkiller.sourceforge.net/">Home</a> |
                <a href="http://netkiller.github.com/">Mirror</a> |
                <a href="/search.html">Search</a></td><td align="right"><form id="searchbox_008589143145807374698:f5uprauilyy" action="/search.html"><input type="hidden" name="cx" value="008589143145807374698:f5uprauilyy" /><input type="hidden" name="cof" value="FORID:11" /><input name="q" type="text" size="25" style="border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(126, 157, 185); border-right-color: rgb(126, 157, 185); border-bottom-color: rgb(126, 157, 185); border-left-color: rgb(126, 157, 185); padding-top: 2px; padding-right: 2px; padding-bottom: 2px; padding-left: 2px; background-image: url(http://www.google.com/cse/intl/en/images/google_custom_search_watermark.gif); background-attachment: initial; background-origin: initial; background-clip: initial; background-color: rgb(255, 255, 255); background-position: 0% 50%; background-repeat: no-repeat no-repeat; " /><input type="submit" name="sa" value="Search" /><input name="siteurl" type="hidden" value="http://netkiller.sourceforge.net/" /></form><script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=searchbox_008589143145807374698%3Af5uprauilyy"></script></td></tr></table><div class="chapter" title="第 6 章 Distributed Filesystem"><div class="titlepage"><div><div><h2 class="title"><a id="distributed-filesystem"></a>第 6 章 Distributed Filesystem</h2></div></div></div><div class="toc"><p><strong>目錄</strong></p><dl><dt><span class="section"><a href="distributed-filesystem.html#drbd">1. DRBD (Distributed Replicated Block Device)</a></span></dt><dd><dl><dt><span class="section"><a href="distributed-filesystem.html#idp418016">1.1. disk and partition</a></span></dt><dt><span class="section"><a href="distributed-filesystem.html#idp418144">1.2. Installation</a></span></dt><dt><span class="section"><a href="distributed-filesystem.html#idp428672">1.3. configure</a></span></dt><dt><span class="section"><a href="distributed-filesystem.html#idp431472">1.4. Starting</a></span></dt><dt><span class="section"><a href="distributed-filesystem.html#idp437056">1.5. Using</a></span></dt></dl></dd><dt><span class="section"><a href="nbd.html">2. Network Block Device protocol</a></span></dt><dd><dl><dt><span class="section"><a href="nbd.html#idp440688">2.1. nbd-server - Network Block Device protocol - server</a></span></dt><dt><span class="section"><a href="nbd.html#idp442016">2.2. nbd-client - Network Block Device protocol - client</a></span></dt></dl></dd><dt><span class="section"><a href="gridfs.html">3. GridFS</a></span></dt><dd><dl><dt><span class="section"><a href="gridfs.html#idp445056">3.1. nginx-gridfs</a></span></dt></dl></dd><dt><span class="section"><a href="moosefs.html">4. Moose File System</a></span></dt><dd><dl><dt><span class="section"><a href="moosefs.html#idp446752">4.1. Master server installation</a></span></dt><dt><span class="section"><a href="moosefs.html#idp453248">4.2. Backup server (metalogger) installation </a></span></dt><dt><span class="section"><a href="moosefs.html#idp456896">4.3. Chunk servers installation</a></span></dt><dt><span class="section"><a href="moosefs.html#idp462288">4.4. Users’ computers installation</a></span></dt><dt><span class="section"><a href="moosefs.html#idp466000">4.5. Testing MFS</a></span></dt></dl></dd><dt><span class="section"><a href="gluster.html">5. GlusterFS</a></span></dt><dd><dl><dt><span class="section"><a href="gluster.html#idp472000">5.1. glusterfs-server</a></span></dt><dt><span class="section"><a href="gluster.html#idp476432">5.2. glusterfs-client</a></span></dt><dt><span class="section"><a href="gluster.html#idp481824">5.3. Testing</a></span></dt><dt><span class="section"><a href="gluster.html#gluster.raid">5.4. RAID</a></span></dt><dd><dl><dt><span class="section"><a href="gluster.html#idp485840">5.4.1. Mirror</a></span></dt><dt><span class="section"><a href="gluster.html#idp487696">5.4.2. Strip</a></span></dt></dl></dd><dt><span class="section"><a href="gluster.html#idp489168">5.5. Filesystem Administration</a></span></dt></dl></dd><dt><span class="section"><a href="lustre.html">6. Lustre</a></span></dt><dt><span class="section"><a href="hdfs.html">7. Hadoop - HDFS</a></span></dt><dt><span class="section"><a href="mogilefs.html">8. MogileFS</a></span></dt><dt><span class="section"><a href="ceph.html">9. Ceph</a></span></dt><dt><span class="section"><a href="kfs.html">10. Kosmos distributed file system (KFS)</a></span></dt><dt><span class="section"><a href="coda.html">11. Coda</a></span></dt><dt><span class="section"><a href="openafs.html">12. OpenAFS</a></span></dt><dt><span class="section"><a href="fam-imon.html">13. fam &amp; imon</a></span></dt></dl></div><div class="section" title="1. DRBD (Distributed Replicated Block Device)"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="drbd"></a>1. DRBD (Distributed Replicated Block Device)</h2></div></div></div><p>Homepage: http://www.drbd.org/</p><div><img src="images/storage/drbd.gif" /></div><div><img src="images/storage/drbd_ha.gif" /></div><p>實驗環境需要兩台電腦，如果你沒有，建議你使用VMware，並且為每一個虛擬機添加兩塊硬碟。</p><div class="orderedlist" title="實驗環境"><p class="title"><strong>實驗環境</strong></p><ol class="orderedlist" type="1"><li class="listitem"><p>master: 192.168.0.1 	DRBD:/dev/sdb </p></li><li class="listitem"><p>slave: 	192.168.0.2 	DRBD:/dev/sdb </p></li></ol></div><div class="section" title="1.1. disk and partition"><div class="titlepage"><div><div><h3 class="title"><a id="idp418016"></a>1.1. disk and partition</h3></div></div></div><p>Each of the following steps must be completed on both nodes</p><p>show all of disk and partition</p><pre class="screen">
neo@master:~$ sudo sfdisk -s
/dev/sda:   8388608
/dev/sdb:   2097152
total: 10485760 blocks
			</pre><p>create a new partition on the disk /dev/sdb</p><pre class="screen">
$ sudo cfdisk /dev/sdb			
			</pre><p>you must have extended partition</p><p>check partition</p><pre class="screen">
neo@master:~$ sudo fdisk -l

Disk /dev/sda: 8589 MB, 8589934592 bytes
255 heads, 63 sectors/track, 1044 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Disk identifier: 0x000301bd

   Device Boot      Start         End      Blocks   Id  System
/dev/sda1   *           1         993     7976241   83  Linux
/dev/sda2             994        1044      409657+   5  Extended
/dev/sda5             994        1044      409626   82  Linux swap / Solaris

Disk /dev/sdb: 2147 MB, 2147483648 bytes
255 heads, 63 sectors/track, 261 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Disk identifier: 0x00000000

   Device Boot      Start         End      Blocks   Id  System
/dev/sdb1               1         261     2096451    5  Extended
/dev/sdb5               1         261     2096419+  83  Linux

			</pre><p>format /dev/sdb1</p><pre class="screen">
neo@master:~$ sudo mkfs.ext3 /dev/sdb1
			</pre><p>you also can using other file system</p><p>reiserfs</p><pre class="screen">
neo@master:~$ sudo mkfs.reiserfs /dev/sdb1		
			</pre><p>I suggest you using reiserfs.</p></div><div class="section" title="1.2. Installation"><div class="titlepage"><div><div><h3 class="title"><a id="idp418144"></a>1.2. Installation</h3></div></div></div><p>Each of the following steps must be completed on both nodes</p><p>search drbd8-utils package</p><pre class="screen">
neo@master:~$ apt-cache search drbd
drbd8-utils - RAID 1 over tcp/ip for Linux utilities
drbd0.7-module-source - RAID 1 over tcp/ip for Linux module source
drbd0.7-utils - RAID 1 over tcp/ip for Linux utilities
drbdlinks - Manages symlinks into a shared DRBD partition
			</pre><p>installation</p><pre class="screen">
neo@master:~$ sudo apt-get install drbd8-utils			
			</pre><p>to add modules from the Linux Kernel</p><pre class="screen">
neo@master:~$ sudo modprobe drbd
neo@master:~$ lsmod |grep drbd
drbd                  213000  0
cn                      9632  1 drbd
			
			</pre></div><div class="section" title="1.3. configure"><div class="titlepage"><div><div><h3 class="title"><a id="idp428672"></a>1.3. configure</h3></div></div></div><p>Each of the following steps must be completed on both nodes</p><p>backup configure file</p><pre class="screen">
			
neo@master:~$ sudo cp /etc/drbd.conf /etc/drbd.conf.old
			
			</pre><p>edit /etc/drbd.conf</p><pre class="screen">
global { 
  usage-count yes; 
}
common {
  protocol C;
}
resource r0 {
  on master {
    device    /dev/drbd0;
    disk      /dev/sdb5;
    address   192.168.0.1:7789;
    meta-disk internal;
  }
  on slave {
    device    /dev/drbd0;
    disk      /dev/sdb5;
    address   10.1.1.32:7789;
    meta-disk internal;
  }
}
			</pre></div><div class="section" title="1.4. Starting"><div class="titlepage"><div><div><h3 class="title"><a id="idp431472"></a>1.4. Starting</h3></div></div></div><p>Each of the following steps must be completed on both nodes.</p><pre class="screen">
neo@master:~$ sudo drbdadm create-md r0	
neo@master:~$ sudo drbdadm attach r0
neo@master:~$ sudo drbdadm connect r0
neo@master:~$ sudo drbdadm -- --overwrite-data-of-peer primary r0

neo@slave:~$ sudo drbdadm create-md r0		
neo@slave:~$ sudo drbdadm attach r0
neo@slave:~$ sudo drbdadm connect r0

			</pre><p>master</p><pre class="screen">
			
neo@master:~$ sudo drbdadm create-md r0
v08 Magic number not found
md_offset 2146725888
al_offset 2146693120
bm_offset 2146627584

Found some data
 ==&gt; This might destroy existing data! &lt;==

Do you want to proceed?
[need to type 'yes' to confirm] yes

v07 Magic number not found
v07 Magic number not found
v08 Magic number not found
Writing meta data...
initialising activity log
NOT initialized bitmap
New drbd meta data block sucessfully created.
success
			
			</pre><p>slave</p><pre class="screen">
			
neo@slave:~# sudo drbdadm create-md r0
v08 Magic number not found
md_offset 2146725888
al_offset 2146693120
bm_offset 2146627584

Found some data
 ==&gt; This might destroy existing data! &lt;==

Do you want to proceed?
[need to type 'yes' to confirm] yes

v07 Magic number not found
v07 Magic number not found
v08 Magic number not found
Writing meta data...
initialising activity log
NOT initialized bitmap
New drbd meta data block sucessfully created.
success
			
			</pre><p>status</p><pre class="screen">
neo@master:~$ cat /proc/drbd
version: 8.0.11 (api:86/proto:86)
GIT-hash: b3fe2bdfd3b9f7c2f923186883eb9e2a0d3a5b1b build by phil@mescal, 2008-02-12 11:56:43
 0: cs:StandAlone st:Primary/Unknown ds:UpToDate/DUnknown   r---
    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0
        resync: used:0/31 hits:0 misses:0 starving:0 dirty:0 changed:0
        act_log: used:0/127 hits:0 misses:0 starving:0 dirty:0 changed:0
 1: cs:Connected st:Secondary/Secondary ds:Diskless/Inconsistent C r---
    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0
			
			</pre></div><div class="section" title="1.5. Using"><div class="titlepage"><div><div><h3 class="title"><a id="idp437056"></a>1.5. Using</h3></div></div></div><p>master</p><pre class="screen">
neo@master:~$ sudo drbdadm primary all		
neo@master:~$ sudo mkfs.reiserfs /dev/drbd0
neo@master:~$ sudo mkdir /mnt/drbd0
neo@master:~$ sudo mount /dev/drbd0 /mnt/drbd0/
neo@master:~$ sudo touch /mnt/drbd0/helloworld.tmp
neo@master:~$ df -h
Filesystem            Size  Used Avail Use% Mounted on
/dev/sda1             7.6G  1.3G  6.0G  18% /
varrun                125M  216K  125M   1% /var/run
varlock               125M  8.0K  125M   1% /var/lock
udev                  125M   60K  125M   1% /dev
devshm                125M     0  125M   0% /dev/shm
/dev/drbd0            2.0G   33M  2.0G   2% /mnt/drbd0
neo@master:~$ sudo dd if=/dev/zero of=/mnt/drbd0/tempfile1.tmp bs=104857600 count=1
1+0 records in
1+0 records out
104857600 bytes (105 MB) copied, 0.564911 s, 186 MB/s
neo@master:~$ sudo umount /mnt/drbd0/
neo@master:~$ sudo drbdadm secondary all
			</pre><p>slave</p><pre class="screen">
neo@slave:~$ sudo drbdadm primary all			
neo@slave:~$ sudo mkdir /mnt/drbd0
neo@slave:~$ sudo mount /dev/drbd0 /mnt/drbd0/
neo@slave:~$ ls /mnt/drbd0/
helloworld.tmp  tempfile1.tmp			
			</pre></div></div></div><div xmlns="" id="disqus_thread"></div><script xmlns="" type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

            if(document.domain == 'netkiller.github.com'){
            var disqus_shortname = 'netkiller'; // required: replace example with your forum shortname
            }else{
			var disqus_shortname = 'neochan';
            }

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script><noscript xmlns="">Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a xmlns="" href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="samba.html">上一頁</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="nbd.html">下一頁</a></td></tr><tr><td width="40%" align="left" valign="top">2. Samba </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始頁</a></td><td width="40%" align="right" valign="top"> 2. Network Block Device protocol</td></tr></table></div></body></html>

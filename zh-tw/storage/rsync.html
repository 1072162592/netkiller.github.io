<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>2. rsync - fast remote file copy program (like rcp)</title><link rel="stylesheet" type="text/css" href="/docbook.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.76.1" /><meta name="keywords" content="openfiler, freenas, proftpd,pureftpd,vsftpd, rsync,wget,samba" /><link rel="home" href="index.html" title="Netkiller Linux Storage 手札" /><link rel="up" href="synchronize.html" title="第 4 章 File Synchronize" /><link rel="prev" href="synchronize.html" title="第 4 章 File Synchronize" /><link rel="next" href="tsync.html" title="3. tsync" /><script xmlns="" type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11694057-1']);
  _gaq.push(['_setDomainName', 'netkiller.sourceforge.net']);
  _gaq.push(['_setAllowHash', 'false']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">2. rsync - fast remote file copy program (like rcp)</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="synchronize.html">上一頁</a> </td><th width="60%" align="center">第 4 章 File Synchronize</th><td width="20%" align="right"> <a accesskey="n" href="tsync.html">下一頁</a></td></tr></table><hr /></div><table xmlns="" width="100%" border="0"><tr><td align="left"><a href="http://netkiller.sourceforge.net/">Home</a> |
                <a href="http://netkiller.github.com/">Mirror</a> |
                <a href="/search.html">Search</a></td><td><div id="bdshare" class="bdshare_t bds_tools_32 get-codes-bdshare"><a class="bds_fbook"></a><a class="bds_twi"></a><a class="bds_ms"></a><a class="bds_msn"></a><a class="bds_buzz"></a><a class="bds_linkedin"></a><a class="bds_deli"></a><a class="bds_qzone"></a><a class="bds_qq"></a><a class="bds_tqq"></a><a class="bds_tqf"></a><a class="bds_tsina"></a><a class="bds_baidu"></a><a class="bds_renren"></a><a class="bds_t163"></a><a class="bds_tfh"></a><a class="bds_ty"></a><a class="bds_s51"></a><a class="bds_douban"></a><a class="bds_hi"></a><a class="bds_tieba"></a><a class="bds_tsohu"></a><a class="bds_kaixin001"></a><a class="bds_fx"></a><a class="bds_meilishuo"></a><a class="bds_zx"></a><a class="bds_tuita"></a><span class="bds_more"></span><a class="shareCount"></a></div><script type="text/javascript" id="bdshare_js" data="type=tools"></script><script type="text/javascript" id="bdshell_js"></script><script type="text/javascript">
	document.getElementById("bdshell_js").src = "http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion=" + new Date().getHours();
</script></td><td><form id="searchbox_008589143145807374698:f5uprauilyy" action="/search.html"><input type="hidden" name="cx" value="008589143145807374698:f5uprauilyy" /><input type="hidden" name="cof" value="FORID:11" /><input name="q" type="text" size="25" style="border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(126, 157, 185); border-right-color: rgb(126, 157, 185); border-bottom-color: rgb(126, 157, 185); border-left-color: rgb(126, 157, 185); padding-top: 2px; padding-right: 2px; padding-bottom: 2px; padding-left: 2px; background-image: url(http://www.google.com/cse/intl/en/images/google_custom_search_watermark.gif); background-attachment: initial; background-origin: initial; background-clip: initial; background-color: rgb(255, 255, 255); background-position: 0% 50%; background-repeat: no-repeat no-repeat; " /><input type="submit" name="sa" value="Search" /><input name="siteurl" type="hidden" value="http://netkiller.sourceforge.net/" /></form><script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=searchbox_008589143145807374698%3Af5uprauilyy"></script></td></tr></table><div class="section" title="2. rsync - fast remote file copy program (like rcp)"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="rsync"></a>2. rsync - fast remote file copy program (like rcp)</h2></div></div></div><p>rsync is an open source utility that provides fast incremental file transfer. rsync is freely available under the GNU General Public License version 2 and is currently being maintained by Wayne Davison.</p><div class="section" title="2.1. 安裝Rsync與配置守護進程"><div class="titlepage"><div><div><h3 class="title"><a id="idp246352"></a>2.1. 安裝Rsync與配置守護進程</h3></div></div></div><div class="section" title="2.1.1. install with source"><div class="titlepage"><div><div><h4 class="title"><a id="idp246784"></a>2.1.1. install with source</h4></div></div></div><div class="procedure" title="過程 4.1. rsync"><a id="idp247232"></a><p class="title"><strong>過程 4.1. rsync</strong></p><ol class="procedure" type="1"><li class="step" title="步驟 1"><p>安裝rsync</p><p>在AS3 第二張CD上找到rsync-2.5.6-20.i386.rpm</p><pre class="screen">
[root@linuxas3 root]# cd /mnt
[root@linuxas3 mnt]# mount cdrom
[root@linuxas3 mnt]# cd cdrom/RedHat/RPMS
[root@linuxas3 RPMS]# rpm -ivh rsync-2.5.6-20.i386.rpm
			</pre></li><li class="step" title="步驟 2"><p>配置/etc/rsyncd.conf</p><p>在rh9,as3系統上rsync安裝後,並沒有創建rsyncd.conf文檔，要自己創建rsyncd.conf文檔</p><pre class="screen">
[root@linuxas3 root]# vi /etc/rsyncd.conf

uid=nobody
gid=nobody
max connections=5
use chroot=no
log file=/var/log/rsyncd.log
pid file=/var/run/rsyncd.pid
lock file=/var/run/rsyncd.lock
#auth users=root
secrets file=/etc/rsyncd.passwd

[postfix]
path=/var/mail
comment = backup mail
ignore errors
read only = yes
list = no
auth users = postfix

[netkiller]
path=/home/netkiller/web
comment = backup 9812.net
ignore errors
read only = yes
list = no
auth users = netkiller

[pgsqldb]
path=/var/lib/pgsql
comment = backup postgresql database
ignore errors
read only = yes
list = no
			</pre><ol type="a" class="substeps"><li class="step" title="步驟 2.a"><p>選項說明</p><pre class="screen">
uid = nobody
gid = nobody
use chroot = no         # 不使用chroot
max connections = 4     # 最大連接數為4
pid file = /var/run/rsyncd.pid           #進程ID檔案
lock file = /var/run/rsync.lock
log file = /var/log/rsyncd.log    # 日誌記錄檔案
secrets file = /etc/rsyncd.pwd    # 認證檔案名,主要保存用戶密碼，權限建議設為600，所有者root

[module]            # 這裡是認證的模組名，在client端需要指定
path = /var/mail    # 需要做鏡像的目錄
comment = backup xxxx # 註釋
ignore errors         # 可以忽略一些無關的IO錯誤
read only = yes       # 只讀
list = no             # 不允許列檔案
auth users = postfix  # 認證的用戶名，如果沒有這行，則表明是匿名

[other]
path = /path/to...
comment = xxxxx
		    	</pre></li><li class="step" title="步驟 2.b"><p>密碼檔案</p><p>在server端生成一個密碼檔案/etc/rsyncd.pwd</p><pre class="screen">
[root@linuxas3 root]# echo postfix:xxx &gt;&gt;/etc/rsyncd.pwd
[root@linuxas3 root]# echo netkiller:xxx &gt;&gt;/etc/rsyncd.pwd
[root@linuxas3 root]# chmod 600 /etc/rsyncd.pwd
		    	</pre></li><li class="step" title="步驟 2.c"><p>啟動rsync daemon</p><pre class="screen">
[root@linuxas3 root]# rsync --daemon
		    	</pre></li></ol></li><li class="step" title="步驟 3"><p>添加到啟動檔案</p><pre class="screen">
echo　"rsync　--daemon"　&gt;&gt;　/etc/rc.d/rc.local                                    [  OK  ]
			</pre><p>cat /etc/rc.d/rc.local 確認一下</p></li><li class="step" title="步驟 4"><p>測試</p><pre class="screen">
[root@linux docbook]#  rsync rsync://netkiller.8800.org/netkiller
[root@linux tmp]# rsync rsync://netkiller@netkiller.8800.org/netkiller
Password:

[chen@linux temp]$  rsync -vzrtopg --progress --delete postfix@netkiller.8800.org::postfix /tmp
Password:
			</pre></li></ol></div></div><div class="section" title="2.1.2. install with aptitude"><div class="titlepage"><div><div><h4 class="title"><a id="idp260576"></a>2.1.2. install with aptitude</h4></div></div></div><div class="procedure" title="過程 4.2. installation setp by setp"><a id="idp260960"></a><p class="title"><strong>過程 4.2. installation setp by setp</strong></p><ol class="procedure" type="1"><li class="step" title="步驟 1"><p>installation</p><pre class="screen">
$ sudo apt-get install rsync
			</pre></li><li class="step" title="步驟 2"><p>enable</p><pre class="screen">
$ sudo vim /etc/default/rsync

RSYNC_ENABLE=true
			</pre></li><li class="step" title="步驟 3"><p>config /etc/rsyncd.conf</p><pre class="screen">
$ sudo vim /etc/rsyncd.conf

uid=nobody
gid=nobody
max connections=5
use chroot=no
pid file=/var/run/rsyncd.pid
lock file=/var/run/rsyncd.lock
log file=/var/log/rsyncd.log
#auth users=root
secrets file=/etc/rsyncd.secrets

[neo]
path=/home/neo/www
comment = backup neo
ignore errors
read only = yes
list = no
auth users = neo

[netkiller]
path=/home/netkiller/public_html
comment = backup netkiller
ignore errors
read only = yes
list = no
auth users = netkiller

[mirror]
path=/var/www/netkiller.8800.org/html/
comment = mirror netkiller.8800.org
exclude = .svn
ignore errors
read only = yes
list = yes

[music]
path=/var/music
comment = backup music database
ignore errors
read only = yes
list = no

[pgsqldb]
path=/var/lib/pgsql
comment = backup postgresql database
ignore errors
read only = yes
list = no
auth users = neo,netkiller
			</pre></li><li class="step" title="步驟 4"><p>/etc/rsyncd.secrets</p><pre class="screen">
$ sudo vim  /etc/rsyncd.secrets

neo:123456
netkiller:123456
			</pre><p></p><pre class="screen">
$ sudo chmod 600 /etc/rsyncd.secrets
			</pre></li><li class="step" title="步驟 5"><p>start</p><pre class="screen">
$ sudo /etc/init.d/rsync start
			</pre></li><li class="step" title="步驟 6"><p>test</p><pre class="screen">
$ rsync -vzrtopg --progress --delete neo@localhost::neo /tmp/test1/
$ rsync -vzrtopg --progress --delete localhost::music /tmp/test2/
			</pre></li><li class="step" title="步驟 7"><p>firewall</p><pre class="screen">
$ sudo ufw allow rsync
			</pre></li></ol></div></div><div class="section" title="2.1.3. xinetd"><div class="titlepage"><div><div><h4 class="title"><a id="rsync.xinetd"></a>2.1.3. xinetd</h4></div></div></div><pre class="screen">
yum install xinetd
		</pre><p>配置 /etc/xinetd.d/rsync</p><pre class="screen">
vim /etc/xinetd.d/rsync

# default: off
# description: The rsync server is a good addition to an ftp server, as it \
#	allows crc checksumming etc.
service rsync
{
	disable	= yes
	flags		= IPv6
	socket_type     = stream
	wait            = no
	user            = root
	server          = /usr/bin/rsync
	server_args     = --daemon
	log_on_failure  += USERID
}
		</pre><p>disable	= yes 改為 disable	= no</p><p># vim /etc/rsyncd.conf</p><pre class="screen">
chkconfig xinetd on
/etc/init.d/xinetd restart
		</pre></div></div><div class="section" title="2.2. rsyncd.conf"><div class="titlepage"><div><div><h3 class="title"><a id="idp275536"></a>2.2. rsyncd.conf</h3></div></div></div><pre class="screen">
# Minimal configuration file for rsync daemon
# See rsync(1) and rsyncd.conf(5) man pages for help

# This line is required by the /etc/init.d/rsyncd script
pid file = /var/run/rsyncd.pid
port = 873
address = 192.168.1.171
#uid = nobody
#gid = nobody
uid = root
gid = root

use chroot = yes
read only = yes


#limit access to private LANs
hosts allow=192.168.1.0/255.255.255.0 10.0.1.0/255.255.255.0
hosts deny=*

max connections = 5
motd file = /etc/rsyncd/rsyncd.motd

#This will give you a separate log file
#log file = /var/log/rsync.log

#This will log every file transferred - up to 85,000+ per user, per sync
#transfer logging = yes

log format = %t %a %m %f %b
syslog facility = local3
timeout = 300

[home]
path = /home
list=yes
ignore errors
auth users = linux
secrets file = /etc/rsyncd/rsyncd.secrets
comment = linuxsir home
exclude =   beinan/  samba/

[beinan]
path = /opt
list=no
ignore errors
comment = optdir
auth users = beinan
secrets file = /etc/rsyncd/rsyncd.secrets

[www]
path = /www/
ignore errors
read only = true
list = false
hosts allow = 172.16.1.1
hosts deny = 0.0.0.0/32
auth users = backup
secrets file = /etc/backserver.pas


[web_user1]
path = /home/web_user1/
ignore errors
read only = true
list = false
hosts allow = 202.99.11.121
hosts deny = 0.0.0.0/32
uid = web_user1
gid = web_user1
auth users = backup
secrets file = /etc/backserver.pas


[pub]
  	comment = Random things available for download
  	path = /path/to/my/public/share
  	read only = yes
  	list = yes
  	uid = nobody
  	gid = nobody
  	auth users = pub
  	secrets file = /etc/rsyncd.secrets
		</pre></div><div class="section" title="2.3. upload"><div class="titlepage"><div><div><h3 class="title"><a id="idp278064"></a>2.3. upload</h3></div></div></div><pre class="screen">
$ rsync -v -u -a --delete --rsh=ssh --stats localfile username@hostname:/home/username/
		</pre><p>for example:</p><p>I want to copy local workspace of eclipse directory to another computer.</p><pre class="screen">
$ rsync -v -u -a --delete --rsh=ssh --stats workspace neo@192.168.245.131:/home/neo/
		</pre></div><div class="section" title="2.4. download"><div class="titlepage"><div><div><h3 class="title"><a id="idp280176"></a>2.4. download</h3></div></div></div><pre class="screen">
$ rsync -v -u -a --delete --rsh=ssh --stats neo@192.168.245.131:/home/neo/* /tmp/
		</pre></div><div class="section" title="2.5. mirror"><div class="titlepage"><div><div><h3 class="title"><a id="idp281056"></a>2.5. mirror</h3></div></div></div><p>rsync使用方法</p><p>rsync rsync://認證用戶@主機/模組</p><pre class="screen">
rsync -vzrtopg --progress --delete 認證用戶@主機::模組 /mirror目錄
		</pre></div><div class="section" title="2.6. step by step to learn rsync"><div class="titlepage"><div><div><h3 class="title"><a id="idp282512"></a>2.6. step by step to learn rsync</h3></div></div></div><div class="procedure"><ol class="procedure" type="1"><li class="step" title="步驟 1"><p>transfer file from src to dest directory</p><pre class="screen">
neo@netkiller:/tmp$ mkdir rsync
neo@netkiller:/tmp$ cd rsync/
neo@netkiller:/tmp/rsync$ ls
neo@netkiller:/tmp/rsync$ mkdir src dest
neo@netkiller:/tmp/rsync$ echo file1 &gt; src/file1
neo@netkiller:/tmp/rsync$ echo file2 &gt; src/file2
neo@netkiller:/tmp/rsync$ echo file3 &gt; src/file3
				</pre></li><li class="step" title="步驟 2"><p>skipping directory</p><pre class="screen">
neo@netkiller:/tmp/rsync$ mkdir src/dir1
neo@netkiller:/tmp/rsync$ mkdir src/dir2
neo@netkiller:/tmp/rsync$ rsync src/* dest/
skipping directory src/dir1
skipping directory src/dir2
				</pre></li><li class="step" title="步驟 3"><p>recurse into directories</p><pre class="screen">
neo@netkiller:/tmp/rsync$ rsync -r src/* dest/
neo@netkiller:/tmp/rsync$ ls dest/
dir1  dir2  file1  file2  file3
				</pre></li><li class="step" title="步驟 4"><p>backup</p><pre class="screen">
neo@netkiller:/tmp/rsync$ rsync -r --backup --suffix=.2008-11-21 src/* dest/
neo@netkiller:/tmp/rsync$ ls dest/
dir1  dir2  file1  file1.2008-11-21  file2  file2.2008-11-21  file3  file3.2008-11-21
neo@netkiller:/tmp/rsync$
				</pre><p>backup-dir</p><pre class="screen">
neo@netkiller:/tmp/rsync$ rsync -r --backup --suffix=.2008-11-21 --backup-dir mybackup src/* dest/
neo@netkiller:/tmp/rsync$ ls dest/
dir1  dir2  file1  file1.2008-11-21  file2  file2.2008-11-21  file3  file3.2008-11-21  mybackup
neo@netkiller:/tmp/rsync$ ls dest/mybackup/
file1.2008-11-21  file2.2008-11-21  file3.2008-11-21
				</pre><p></p><pre class="screen">
rsync -r --backup --suffix=.2008-11-21 --backup-dir ../mybackup src/* dest/
neo@netkiller:/tmp/rsync$ ls
dest  mybackup  src
neo@netkiller:/tmp/rsync$ ls src/
dir1  dir2  file1  file2  file3
				</pre></li><li class="step" title="步驟 5"><p>update</p><pre class="screen">
neo@netkiller:/tmp/rsync$ rm -rf dest/*
neo@netkiller:/tmp/rsync$ rsync -r -u src/* dest/
neo@netkiller:/tmp/rsync$ echo netkiller&gt;&gt;src/file2
neo@netkiller:/tmp/rsync$ rsync -v -r -u src/* dest/
building file list ... done
file2

sent 166 bytes  received 42 bytes  416.00 bytes/sec
total size is 38  speedup is 0.18
				</pre><p>update by time and size</p><pre class="screen">
neo@netkiller:/tmp/rsync$ echo Hi&gt;src/dir1/file1.1
neo@netkiller:/tmp/rsync$ rsync -v -r -u src/* dest/
building file list ... done
dir1/file1.1

sent 166 bytes  received 42 bytes  416.00 bytes/sec
total size is 41  speedup is 0.20
				</pre></li><li class="step" title="步驟 6"><p>--archive</p><pre class="screen">
rsync -a src/ dest/
				</pre></li><li class="step" title="步驟 7"><p>--compress</p><pre class="screen">
rsync -a -z src/ dest/
				</pre></li><li class="step" title="步驟 8"><p>--delete</p><p>src</p><pre class="screen">
svn@netkiller:~$ ls src/
dir1  dir2  file1  file2  file3
				</pre><p>dest</p><pre class="screen">
neo@netkiller:~$ rsync -v -u -a --delete -e ssh svnroot@127.0.0.1:/home/svnroot/src /tmp/dest
svnroot@127.0.0.1's password:
receiving file list ... done
created directory /tmp/dest
src/
src/file1
src/file2
src/file3
src/dir1/
src/dir2/

sent 104 bytes  received 309 bytes  118.00 bytes/sec
total size is 0  speedup is 0.00
				</pre><p>src</p><pre class="screen">
svn@netkiller:~$ rm -rf src/file2
svn@netkiller:~$ rm -rf src/dir2
				</pre><p>dest</p><pre class="screen">
neo@netkiller:~$ rsync -v -u -a --delete -e ssh svnroot@127.0.0.1:/home/svnroot/src /tmp/dest
svnroot@127.0.0.1's password:
receiving file list ... done
deleting src/dir2/
deleting src/file2
src/

sent 26 bytes  received 144 bytes  68.00 bytes/sec
total size is 0  speedup is 0.00
				</pre></li></ol></div></div><div class="section" title="2.7. rsync examples"><div class="titlepage"><div><div><h3 class="title"><a id="idp301184"></a>2.7. rsync examples</h3></div></div></div><p><a class="ulink" href="http://samba.anu.edu.au/rsync/examples.html" target="_top">http://samba.anu.edu.au/rsync/examples.html</a></p><div class="section" title="2.7.1. rsync delete"><div class="titlepage"><div><div><h4 class="title"><a id="idp302352"></a>2.7.1. rsync delete</h4></div></div></div><div class="example"><a id="idp302736"></a><p class="title"><strong>例 4.1. examples</strong></p><div class="example-contents"><p>用rsync刪除目標目錄</p><div class="literallayout"><p><br />
				<br />
mkdir /root/blank<br />
rsync --delete-before -a -H -v --progress --stats /root/blank/ ./cache/<br />
				<br />
				</p></div></div></div><br class="example-break" /></div><div class="section" title="2.7.2. backup to a central backup server with 7 day incremental"><div class="titlepage"><div><div><h4 class="title"><a id="idp304416"></a>2.7.2. backup to a central backup server with 7 day incremental</h4></div></div></div><div class="example"><a id="idp304880"></a><p class="title"><strong>例 4.2. backup to a central backup server with 7 day incremental</strong></p><div class="example-contents"><pre class="screen">
				
#!/bin/sh

# This script does personal backups to a rsync backup server. You will end up
# with a 7 day rotating incremental backup. The incrementals will go
# into subdirectories named after the day of the week, and the current
# full backup goes into a directory called "current"
# tridge@linuxcare.com

# directory to backup
BDIR=/home/$USER

# excludes file - this contains a wildcard pattern per line of files to exclude
EXCLUDES=$HOME/cron/excludes

# the name of the backup machine
BSERVER=owl

# your password on the backup server
export RSYNC_PASSWORD=XXXXXX


########################################################################

BACKUPDIR=`date +%A`
OPTS="--force --ignore-errors --delete-excluded --exclude-from=$EXCLUDES
      --delete --backup --backup-dir=/$BACKUPDIR -a"

export PATH=$PATH:/bin:/usr/bin:/usr/local/bin

# the following line clears the last weeks incremental directory
[ -d $HOME/emptydir ] || mkdir $HOME/emptydir
rsync --delete -a $HOME/emptydir/ $BSERVER::$USER/$BACKUPDIR/
rmdir $HOME/emptydir

# now the actual transfer
rsync $OPTS $BDIR $BSERVER::$USER/current
				
				</pre></div></div><br class="example-break" /></div><div class="section" title="2.7.3. backup to a spare disk"><div class="titlepage"><div><div><h4 class="title"><a id="idp307008"></a>2.7.3. backup to a spare disk</h4></div></div></div><div class="example"><a id="idp307392"></a><p class="title"><strong>例 4.3. backup to a spare disk</strong></p><div class="example-contents"><pre class="screen">
				
I do local backups on several of my machines using rsync. I have an
extra disk installed that can hold all the contents of the main
disk. I then have a nightly cron job that backs up the main disk to
the backup. This is the script I use on one of those machines.

    #!/bin/sh

    export PATH=/usr/local/bin:/usr/bin:/bin

    LIST="rootfs usr data data2"

    for d in $LIST; do
	mount /backup/$d
	rsync -ax --exclude fstab --delete /$d/ /backup/$d/
	umount /backup/$d
    done

    DAY=`date "+%A"`

    rsync -a --delete /usr/local/apache /data2/backups/$DAY
    rsync -a --delete /data/solid /data2/backups/$DAY



The first part does the backup on the spare disk. The second part
backs up the critical parts to daily directories.  I also backup the
critical parts using a rsync over ssh to a remote machine.
				
				</pre></div></div><br class="example-break" /></div><div class="section" title="2.7.4. mirroring vger CVS tree"><div class="titlepage"><div><div><h4 class="title"><a id="idp309216"></a>2.7.4. mirroring vger CVS tree</h4></div></div></div><div class="example"><a id="idp309600"></a><p class="title"><strong>例 4.4. mirroring vger CVS tree</strong></p><div class="example-contents"><pre class="screen">
				
The vger.rutgers.edu cvs tree is mirrored onto cvs.samba.org via
anonymous rsync using the following script.

    #!/bin/bash

    cd /var/www/cvs/vger/
    PATH=/usr/local/bin:/usr/freeware/bin:/usr/bin:/bin

    RUN=`lps x | grep rsync | grep -v grep | wc -l`
    if [ "$RUN" -gt 0 ]; then
	    echo already running
	    exit 1
    fi

    rsync -az vger.rutgers.edu::cvs/CVSROOT/ChangeLog $HOME/ChangeLog

    sum1=`sum $HOME/ChangeLog`
    sum2=`sum /var/www/cvs/vger/CVSROOT/ChangeLog`

    if [ "$sum1" = "$sum2" ]; then
	    echo nothing to do
	    exit 0
    fi

    rsync -az --delete --force vger.rutgers.edu::cvs/ /var/www/cvs/vger/
    exit 0

Note in particular the initial rsync of the ChangeLog to determine if
anything has changed. This could be omitted but it would mean that the
rsyncd on vger would have to build a complete listing of the cvs area
at each run. As most of the time nothing will have changed I wanted to
save the time on vger by only doing a full rsync if the ChangeLog has
changed. This helped quite a lot because vger is low on memory and
generally quite heavily loaded, so doing a listing on such a large
tree every hour would have been excessive.
				
				</pre></div></div><br class="example-break" /></div><div class="section" title="2.7.5. automated backup at home"><div class="titlepage"><div><div><h4 class="title"><a id="idp311792"></a>2.7.5. automated backup at home</h4></div></div></div><div class="example"><a id="idp312176"></a><p class="title"><strong>例 4.5. automated backup at home</strong></p><div class="example-contents"><pre class="screen">
				
I use rsync to backup my wifes home directory across a modem link each
night. The cron job looks like this

    #!/bin/sh
    cd ~susan
    {
    echo
    date
    dest=~/backup/`date +%A`
    mkdir $dest.new
    find . -xdev -type f \( -mtime 0 -or -mtime 1 \) -exec cp -aPv "{}"
    $dest.new \;
    cnt=`find $dest.new -type f | wc -l`
    if [ $cnt -gt 0 ]; then
      rm -rf $dest
      mv $dest.new $dest
    fi
    rm -rf $dest.new
    rsync -Cavze ssh . samba:backup
    } &gt;&gt; ~/backup/backup.log 2&gt;&amp;1


note that most of this script isn't anything to do with rsync, it just
creates a daily backup of Susans work in a ~susan/backup/ directory so
she can retrieve any version from the last week. The last line does
the rsync of her directory across the modem link to the host
samba. Note that I am using the -C option which allows me to add
entries to .cvsignore for stuff that doesn't need to be backed up.
				
				</pre></div></div><br class="example-break" /></div><div class="section" title="2.7.6. Fancy footwork with remote file lists"><div class="titlepage"><div><div><h4 class="title"><a id="idp314128"></a>2.7.6. Fancy footwork with remote file lists</h4></div></div></div><div class="example"><a id="idp314560"></a><p class="title"><strong>例 4.6. Fancy footwork with remote file lists</strong></p><div class="example-contents"><pre class="screen">
				
One little known feature of rsync is the fact that when run over a
remote shell (such as rsh or ssh) you can give any shell command as
the remote file list. The shell command is expanded by your remote
shell before rsync is called. For example, see if you can work out
what this does:

	rsync -avR remote:'`find /home -name "*.[ch]"`' /tmp/

note that that is backquotes enclosed by quotes (some browsers don't
show that correctly).
				
				</pre></div></div><br class="example-break" /></div></div><div class="section" title="2.8. rsync for windows"><div class="titlepage"><div><div><h3 class="title"><a id="idp315984"></a>2.8. rsync for windows</h3></div></div></div><p>http://www.rsync.net/resources/howto/windows_rsync.html</p></div><div class="section" title="2.9. 多進程 rsync 腳本"><div class="titlepage"><div><div><h3 class="title"><a id="idp316688"></a>2.9. 多進程 rsync 腳本</h3></div></div></div><pre class="screen">
		
#!/usr/bin/perl

my $path = "/data";          #本地目錄
my $ip="172.16.xxx.xxx";     #遠程目錄
my $maxchild=5;              #同時並發的個數

open FILE,"ls $path|";
while()
{

        chomp;
        my $filename = $_;
        my $i = 1;
        while($i&lt;=1){
                my $un = `ps -ef |grep rsync|grep -v grep |grep avl|wc -l`;
                $i =$i+1;
                if( $un &lt; $maxchild){
                        system("rsync -avl --size-only $path/$_   $ip:$path &amp;") ;
                }else{
                        sleep 5;
                        $i = 1;
                }
        }
}
		
		</pre></div><div class="section" title="2.10. 數度限制"><div class="titlepage"><div><div><h3 class="title"><a id="idp318240"></a>2.10. 數度限制</h3></div></div></div><p>限製為 100k Bytes/s</p><pre class="screen">
rsync -auvzP--bwlimit=100 /www/* root@172.16.0.1/www
		</pre></div></div><div xmlns="" id="disqus_thread"></div><script xmlns="" type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

            if(document.domain == 'netkiller.github.com'){
            var disqus_shortname = 'netkiller'; // required: replace example with your forum shortname
            }else{
			var disqus_shortname = 'neochan';
            }

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script><noscript xmlns="">Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a xmlns="" href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="synchronize.html">上一頁</a> </td><td width="20%" align="center"><a accesskey="u" href="synchronize.html">上一級</a></td><td width="40%" align="right"> <a accesskey="n" href="tsync.html">下一頁</a></td></tr><tr><td width="40%" align="left" valign="top">第 4 章 File Synchronize </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始頁</a></td><td width="40%" align="right" valign="top"> 3. tsync</td></tr></table></div></body></html>

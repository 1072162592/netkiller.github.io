<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>第 64 章 Linux Virtual Server</title><link rel="stylesheet" href="/docbook.css" type="text/css" /><meta name="generator" content="DocBook XSL Stylesheets V1.75.2" /><link rel="home" href="index.html" title="Netkiller Linux 手札" /><link rel="up" href="cluster.html" title="部分 VI. Cluster" /><link rel="prev" href="cluster.html" title="部分 VI. Cluster" /><link rel="next" href="ch64s02.html" title="2. VS/NAT" /><script xmlns="" type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11694057-1']);
  _gaq.push(['_setDomainName', 'netkiller.sourceforge.net']);
  _gaq.push(['_setAllowHash', 'false']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第 64 章 Linux Virtual Server</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="cluster.html">上一页</a> </td><th width="60%" align="center">部分 VI. Cluster</th><td width="20%" align="right"> <a accesskey="n" href="ch64s02.html">下一页</a></td></tr></table><hr /></div><table xmlns="" width="100%" border="0"><tr><td align="left"><a href="http://netkiller.sourceforge.net/">Home</a> |
                <a href="http://netkiller.github.com/">Mirror</a> |
                <a href="/search.html">Search</a></td><td align="right"><form id="searchbox_008589143145807374698:f5uprauilyy" action="/search.html"><input type="hidden" name="cx" value="008589143145807374698:f5uprauilyy" /><input type="hidden" name="cof" value="FORID:11" /><input name="q" type="text" size="25" style="border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(126, 157, 185); border-right-color: rgb(126, 157, 185); border-bottom-color: rgb(126, 157, 185); border-left-color: rgb(126, 157, 185); padding-top: 2px; padding-right: 2px; padding-bottom: 2px; padding-left: 2px; background-image: url(http://www.google.com/cse/intl/en/images/google_custom_search_watermark.gif); background-attachment: initial; background-origin: initial; background-clip: initial; background-color: rgb(255, 255, 255); background-position: 0% 50%; background-repeat: no-repeat no-repeat; " /><input type="submit" name="sa" value="Search" /><input name="siteurl" type="hidden" value="http://netkiller.sourceforge.net/" /></form><script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=searchbox_008589143145807374698%3Af5uprauilyy"></script></td></tr></table><div class="chapter" title="第 64 章 Linux Virtual Server"><div class="titlepage"><div><div><h2 class="title"><a id="id1360308"></a>第 64 章 Linux Virtual Server</h2></div></div></div><div class="toc"><p><b>目录</b></p><dl><dt><span class="section"><a href="ch64.html#id1360324">1. 环境配置</a></span></dt><dt><span class="section"><a href="ch64s02.html">2. VS/NAT</a></span></dt><dt><span class="section"><a href="ch64s03.html">3. VS/TUN</a></span></dt><dt><span class="section"><a href="ch64s04.html">4. VS/DR</a></span></dt><dd><dl><dt><span class="section"><a href="ch64s04.html#id1360608">4.1. 配置文件</a></span></dt><dd><dl><dt><span class="section"><a href="ch64s04.html#id1360612">4.1.1. Director</a></span></dt><dt><span class="section"><a href="ch64s04.html#id1360644">4.1.2. RealServer</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="ch64s05.html">5. ipvsadm script</a></span></dt><dt><span class="section"><a href="ch64s06.html">6. debug</a></span></dt><dt><span class="section"><a href="ch64s07.html">7. ipvsadm monitor</a></span></dt></dl></div><p>Session</p><p>
当选用持久服务（-p选项）支持HTTP session时，来自同一IP地址的请求将被送到同一台服务器。所以在这种状况下，一个ab生成的请求都会被调度到一台服务器，达不到性能测试的目的。在真实系统使用中，持久服务时间一般设置好几个小时。

当ldirectord监测到并且在列表中删除一台应用服务器时，之前有建立连接的,继续转发到这台机上，确实是这样。因为IPVS并不立即淘汰刚删除的服务器，考虑到服务器太忙被删除，可能很快会被加回来。如果你需要马上淘汰已删除服务器的连接，可以用

echo 1 &gt; /proc/sys/net/ipv4/vs/expire_nodest_conn

不用担心记录连接所消耗的内存，因为一个连接只占用128个字节，所以512M可用内存可以支持四百万条连接数。

可以考虑用分布式的测试工具，或者多台机器一起跑ab。

	</p><div class="section" title="1. 环境配置"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id1360324"></a>1. 环境配置</h2></div></div></div><p>ssh</p><pre class="screen">
neo@ubuntu:~$ sudo apt-get install ssh
		</pre><p>network</p><pre class="screen">
neo@ubuntu:~$ sudo ifconfig eth0 172.16.0.250
neo@ubuntu:~$ sudo route add default gw 172.16.0.254
		</pre><p>install ipvsadm</p><pre class="screen">
neo@ubuntu:~$ apt-cache search ipvsadm
ipvsadm - Linux Virtual Server support programs
neo@ubuntu:~$ sudo apt-get install ipvsadm
Reading package lists... Done
Building dependency tree
Reading state information... Done
Suggested packages:
  heartbeat keepalived ldirectord
The following NEW packages will be installed:
  ipvsadm
0 upgraded, 1 newly installed, 0 to remove and 30 not upgraded.
Need to get 0B/43.9kB of archives.
After unpacking 238kB of additional disk space will be used.
Preconfiguring packages ...
Selecting previously deselected package ipvsadm.
(Reading database ... 16572 files and directories currently installed.)
Unpacking ipvsadm (from .../ipvsadm_1.24+1.21-1.1ubuntu3_i386.deb) ...
Setting up ipvsadm (1.24+1.21-1.1ubuntu3) ...

neo@ubuntu:~$
		</pre><p>test</p><pre class="screen">
neo@ubuntu:~$ sudo ipvsadm
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
neo@ubuntu:~$
		</pre></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="cluster.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="cluster.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="ch64s02.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">部分 VI. Cluster </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 2. VS/NAT</td></tr></table></div></body></html>

<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>3. Kerberos</title><link rel="stylesheet" href="/docbook.css" type="text/css" /><meta name="generator" content="DocBook XSL Stylesheets V1.75.2" /><link rel="home" href="../index.html" title="Netkiller Linux 手札" /><link rel="up" href="network.authentication.html" title="第 33 章 Network Authentication" /><link rel="prev" href="network.authentication.ldap.html" title="2. OpenLDAP" /><link rel="next" href="freeradius.html" title="4. FreeRADIUS (Remote Authentication Dial In User Service)" /><script xmlns="" type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11694057-1']);
  _gaq.push(['_setDomainName', 'netkiller.sourceforge.net']);
  _gaq.push(['_setAllowHash', 'false']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">3. Kerberos</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="network.authentication.ldap.html">上一页</a> </td><th width="60%" align="center">第 33 章 Network Authentication</th><td width="20%" align="right"> <a accesskey="n" href="freeradius.html">下一页</a></td></tr></table><hr /></div><table xmlns="" width="100%" border="0"><tr><td align="left"><a href="http://netkiller.sourceforge.net/">Home</a> |
                <a href="http://netkiller.github.com/">Mirror</a> |
                <a href="/search.html">Search</a></td><td align="right"><form id="searchbox_008589143145807374698:f5uprauilyy" action="/search.html"><input type="hidden" name="cx" value="008589143145807374698:f5uprauilyy" /><input type="hidden" name="cof" value="FORID:11" /><input name="q" type="text" size="25" style="border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(126, 157, 185); border-right-color: rgb(126, 157, 185); border-bottom-color: rgb(126, 157, 185); border-left-color: rgb(126, 157, 185); padding-top: 2px; padding-right: 2px; padding-bottom: 2px; padding-left: 2px; background-image: url(http://www.google.com/cse/intl/en/images/google_custom_search_watermark.gif); background-attachment: initial; background-origin: initial; background-clip: initial; background-color: rgb(255, 255, 255); background-position: 0% 50%; background-repeat: no-repeat no-repeat; " /><input type="submit" name="sa" value="Search" /><input name="siteurl" type="hidden" value="http://netkiller.sourceforge.net/" /></form><script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=searchbox_008589143145807374698%3Af5uprauilyy"></script></td></tr></table><div class="section" title="3. Kerberos"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="kerberos"></a>3. Kerberos</h2></div><div><h3 class="subtitle">（Kerberos: Network Authentication Protocol）</h3></div></div></div><p>http://web.mit.edu/Kerberos/</p><p>
		kerberos是由MIT开发的提供网络认证服务的系统，很早就听说过它的大名，但一直没有使用过它。
		它可用来为网络上的各种server提供认证服务,使得口令不再是以明文方式在网络上传输，并且联接之间通讯是加密的；
		它和PKI认证的原理不一样，PKI使用公钥体制(不对称密码体制)，kerberos基于私钥体制(对称密码体制)。
	</p><div class="section" title="3.1. Kerberos 安装"><div class="titlepage"><div><div><h3 class="title"><a id="kerberos.install"></a>3.1. Kerberos 安装</h3></div></div></div><div class="section" title="3.1.1. CentOS 安装"><div class="titlepage"><div><div><h4 class="title"><a id="idp1006816"></a>3.1.1. CentOS 安装</h4></div></div></div><p>获得krb5的安装包</p><span class="command"><strong>yum search krb5</strong></span><pre class="screen">
[root@centos ~]# yum search krb5
========================================== Matched: krb5 ===========================================
krb5-auth-dialog.x86_64 : Kerberos 5 authentication dialog
krb5-devel.i386 : Development files needed to compile Kerberos 5 programs.
krb5-devel.x86_64 : Development files needed to compile Kerberos 5 programs.
krb5-libs.i386 : The shared libraries used by Kerberos 5.
krb5-libs.x86_64 : The shared libraries used by Kerberos 5.
krb5-server.x86_64 : The KDC and related programs for Kerberos 5.
krb5-workstation.x86_64 : Kerberos 5 programs for use on workstations.
pam_krb5.i386 : A Pluggable Authentication Module for Kerberos 5.
pam_krb5.x86_64 : A Pluggable Authentication Module for Kerberos 5.
		</pre><p>安装</p><span class="command"><strong>yum install krb5-server.i386</strong></span><pre class="screen">
[root@centos ~]# yum install krb5-server
Setting up Install Process
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package krb5-server.x86_64 0:1.6.1-36.el5_4.1 set to be updated
--&gt; Finished Dependency Resolution

Dependencies Resolved

====================================================================================================
 Package                 Arch               Version                       Repository           Size
====================================================================================================
Installing:
 krb5-server             x86_64             1.6.1-36.el5_4.1              updates             914 k

Transaction Summary
====================================================================================================
Install      1 Package(s)
Update       0 Package(s)
Remove       0 Package(s)

Total download size: 914 k
Is this ok [y/N]: y
Downloading Packages:
krb5-server-1.6.1-36.el5_4.1.x86_64.rpm                                      | 914 kB     00:01
Running rpm_check_debug
Running Transaction Test
Finished Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing     : krb5-server                                                                  1/1

Installed:
  krb5-server.x86_64 0:1.6.1-36.el5_4.1

Complete!
[root@datacenter ~]#Setting up Install Process
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package krb5-server.x86_64 0:1.6.1-36.el5_4.1 set to be updated
--&gt; Finished Dependency Resolution

Dependencies Resolved

====================================================================================================
 Package                 Arch               Version                       Repository           Size
====================================================================================================
Installing:
 krb5-server             x86_64             1.6.1-36.el5_4.1              updates             914 k

Transaction Summary
====================================================================================================
Install      1 Package(s)
Update       0 Package(s)
Remove       0 Package(s)

Total download size: 914 k
Is this ok [y/N]: y
Downloading Packages:
krb5-server-1.6.1-36.el5_4.1.x86_64.rpm                                      | 914 kB     00:01
Running rpm_check_debug
Running Transaction Test
Finished Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing     : krb5-server                                                                  1/1

Installed:
  krb5-server.x86_64 0:1.6.1-36.el5_4.1

Complete!
		</pre><span class="command"><strong>yum install krb5-workstation</strong></span><pre class="screen">
[root@centos ~]# yum install krb5-workstation
		</pre><span class="command"><strong>yum install krb5-libs</strong></span><pre class="screen">
		
		</pre></div><div class="section" title="3.1.2. Install by apt-get"><div class="titlepage"><div><div><h4 class="title"><a id="idp1006944"></a>3.1.2. Install by apt-get</h4></div></div></div><div class="procedure" title="过程 33.3. installation"><a id="idp1016048"></a><p class="title"><b>过程 33.3. installation</b></p><ol class="procedure" type="1"><li class="step" title="步骤 1"><pre class="screen">
$ sudo apt-get install krb5-admin-server		
				</pre></li><li class="step" title="步骤 2"><p>Configuring</p><pre class="screen">
				
  ┌──────────────────────────────┤ Configuring krb5-admin-server ├───────────────────────────────┐
  │                                                                                              │
  │ Setting up a Kerberos Realm                                                                  │
  │                                                                                              │
  │ This package contains the administrative tools required to run the Kerberos master server.   │
  │                                                                                              │
  │ However, installing this package does not automatically set up a Kerberos realm.  This can   │
  │ be done later by running the "krb5_newrealm" command.                                        │
  │                                                                                              │
  │ Please also read the /usr/share/doc/krb5-kdc/README.KDC file and the administration guide    │
  │ found in the krb5-doc package.                                                               │
  │                                                                                              │
  │                                            &lt;Ok&gt;                                              │
  │                                                                                              │
  └──────────────────────────────────────────────────────────────────────────────────────────────┘
				
				</pre><p>OK</p><pre class="screen">
				
 ┌───────────────────────────────┤ Configuring krb5-admin-server ├───────────────────────────────┐
 │                                                                                               │
 │ Kadmind serves requests to add/modify/remove principals in the Kerberos database.             │
 │                                                                                               │
 │ It is required by the kpasswd program, used to change passwords. With standard setups, this   │
 │ daemon should run on the master KDC.                                                          │
 │                                                                                               │
 │ Run the Kerberos V5 administration daemon (kadmind)?                                          │
 │                                                                                               │
 │                           &lt;Yes&gt;                              &lt;No&gt;                             │
 │                                                                                               │
 └───────────────────────────────────────────────────────────────────────────────────────────────┘				
				
				</pre><p>Yes</p></li></ol></div></div></div><div class="section" title="3.2. Kerberos Server"><div class="titlepage"><div><div><h3 class="title"><a id="kerberos.server"></a>3.2. Kerberos Server</h3></div></div></div><div class="procedure" title="过程 33.4. Kerberos Server 配置步骤"><a id="idp1024224"></a><p class="title"><b>过程 33.4. Kerberos Server 配置步骤</b></p><ol class="procedure" type="1"><li class="step" title="步骤 1"><p>Create the Database</p><p>创建Kerberos的本地数据库</p><span class="command"><strong>kdb5_util create -r EXAMPLE.COM -s</strong></span><pre class="screen">
[root@datacenter ~]# kdb5_util create -r EXAMPLE.COM -s
Loading random data
Initializing database '/var/kerberos/krb5kdc/principal' for realm 'EXAMPLE.COM',
master key name 'K/M@EXAMPLE.COM'
You will be prompted for the database Master Password.
It is important that you NOT FORGET this password.
Enter KDC database master key:
Re-enter KDC database master key to verify:		
				</pre></li><li class="step" title="步骤 2"><p>/etc/krb5.conf</p><pre class="screen">
# cp /etc/krb5.conf /etc/krb5.conf.old
# vim /etc/krb5.conf
[logging]
 default = FILE:/var/log/krb5libs.log
 kdc = FILE:/var/log/krb5kdc.log
 admin_server = FILE:/var/log/kadmind.log

[libdefaults]
 default_realm = EXAMPLE.COM
 dns_lookup_realm = false
 dns_lookup_kdc = false
 ticket_lifetime = 24h
 forwardable = yes

[realms]
 EXAMPLE.COM = {
  kdc = kerberos.example.com:88
  admin_server = kerberos.example.com:749
  default_domain = example.com
 }

[domain_realm]
 .example.com = EXAMPLE.COM
 example.com = EXAMPLE.COM

[appdefaults]
 pam = {
   debug = false
   ticket_lifetime = 36000
   renew_lifetime = 36000
   forwardable = true
   krb4_convert = false
 }
				</pre><p>检查下面配置文件 /var/kerberos/krb5kdc/kadm5.acl</p><pre class="screen">
[root@datacenter ~]# cat /var/kerberos/krb5kdc/kadm5.acl
*/admin@EXAMPLE.COM     *
				</pre><p>格式</p><pre class="screen">
The format of the file is:

     Kerberos_principal      permissions     [target_principal]	[restrictions]
				</pre></li><li class="step" title="步骤 3"><p>Add Administrators to the Kerberos Database</p><p>创建账号</p><pre class="screen">
[root@datacenter ~]# kadmin.local
Authenticating as principal root/admin@EXAMPLE.COM with password.
kadmin.local:  addprinc admin/admin@EXAMPLE.COM
WARNING: no policy specified for admin/admin@EXAMPLE.COM; defaulting to no policy
Enter password for principal "admin/admin@EXAMPLE.COM":
Re-enter password for principal "admin/admin@EXAMPLE.COM":
Principal "admin/admin@EXAMPLE.COM" created.
kadmin.local:
				</pre><p>也同样可以使用下面命令</p><span class="command"><strong>kadmin.local -q "addprinc username/admin"</strong></span><pre class="screen">
[root@datacenter ~]# kadmin.local -q "addprinc krbuser"
Authenticating as principal admin/admin@EXAMPLE.COM with password.
WARNING: no policy specified for krbuser@EXAMPLE.COM; defaulting to no policy
Enter password for principal "krbuser@EXAMPLE.COM":
Re-enter password for principal "krbuser@EXAMPLE.COM":
Principal "krbuser@EXAMPLE.COM" created.
				</pre></li><li class="step" title="步骤 4"><p>Create a kadmind Keytab</p><pre class="screen">
				
[root@datacenter ~]# kadmin.local -q  "ktadd -k /var/kerberos/krb5kdc/kadm5.keytab =&gt; kadmin/admin kadmin/changepw"
Authenticating as principal admin/admin@EXAMPLE.COM with password.
kadmin.local: Principal =&gt; does not exist.
Entry for principal kadmin/admin with kvno 3, encryption type Triple DES cbc mode with HMAC/sha1 added to keytab WRFILE:/var/kerberos/krb5kdc/kadm5.keytab.
Entry for principal kadmin/admin with kvno 3, encryption type DES cbc mode with CRC-32 added to keytab WRFILE:/var/kerberos/krb5kdc/kadm5.keytab.
Entry for principal kadmin/changepw with kvno 3, encryption type Triple DES cbc mode with HMAC/sha1 added to keytab WRFILE:/var/kerberos/krb5kdc/kadm5.keytab.
Entry for principal kadmin/changepw with kvno 3, encryption type DES cbc mode with CRC-32 added to keytab WRFILE:/var/kerberos/krb5kdc/kadm5.keytab.				
				
				</pre></li><li class="step" title="步骤 5"><p>Start the Kerberos Daemons on the Master KDC</p><p>启动 Kerberos进程</p><pre class="screen">
[root@datacenter ~]# sudo /etc/init.d/krb524 start
Starting Kerberos 5-to-4 Server:                           [  OK  ]

[root@datacenter ~]# sudo /etc/init.d/krb5kdc restart
Stopping Kerberos 5 KDC:                                   [  OK  ]
Starting Kerberos 5 KDC:                                   [  OK  ]

[root@datacenter ~]# sudo /etc/init.d/kadmin start
Starting Kerberos 5 Admin Server:                          [  OK  ]
				</pre></li><li class="step" title="步骤 6"><p>Log 文件</p><pre class="screen">
[root@datacenter ~]# cat /var/log/krb5kdc.log

[root@datacenter ~]# cat /var/log/krb5libs.log

[root@datacenter ~]# cat /var/log/kadmind.log
				</pre></li></ol></div></div><div class="section" title="3.3. Kerberos Client"><div class="titlepage"><div><div><h3 class="title"><a id="kerberos.client"></a>3.3. Kerberos Client</h3></div></div></div><div class="procedure" title="过程 33.5. Kerberos Client 配置步骤"><a id="idp1040768"></a><p class="title"><b>过程 33.5. Kerberos Client 配置步骤</b></p><ol class="procedure" type="1"><li class="step" title="步骤 1"><p>Ticket Management</p><ol type="a" class="substeps"><li class="step" title="步骤 1.a"><p>Obtaining Tickets with kinit</p><pre class="screen">
[root@datacenter ~]# kinit admin/admin
Password for admin/admin@EXAMPLE.COM:				
				</pre></li><li class="step" title="步骤 1.b"><p>Viewing Your Tickets with klist</p><pre class="screen">
[root@datacenter ~]# klist
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: admin/admin@EXAMPLE.COM

Valid starting     Expires            Service principal
03/25/10 16:15:18  03/26/10 16:15:18  krbtgt/EXAMPLE.COM@ZEXAMPLECOM


Kerberos 4 ticket cache: /tmp/tkt0
klist: You have no tickets cached
				</pre></li><li class="step" title="步骤 1.c"><p>Destroying Your Tickets with kdestroy</p><pre class="screen">
[root@datacenter ~]# kdestroy
[root@datacenter ~]# klist
klist: No credentials cache found (ticket cache FILE:/tmp/krb5cc_0)


Kerberos 4 ticket cache: /tmp/tkt0
klist: You have no tickets cached
				</pre></li></ol></li><li class="step" title="步骤 2"><p>Password Management</p><p>Changing Your Password</p><pre class="screen"> 
				   
[root@datacenter ~]# kpasswd
Password for admin/admin@EXAMPLE.COM:
Enter new password:
Enter it again:
Password changed.
				
				</pre></li></ol></div></div><div class="section" title="3.4. Kerberos Management"><div class="titlepage"><div><div><h3 class="title"><a id="kerberos.management"></a>3.4. Kerberos Management</h3></div></div></div><div class="section" title="3.4.1. ktutil - Kerberos keytab file maintenance utility"><div class="titlepage"><div><div><h4 class="title"><a id="idp1049168"></a>3.4.1. ktutil - Kerberos keytab file maintenance utility</h4></div></div></div><pre class="screen">
[root@datacenter ~]# ktutil
ktutil: rkt /var/kerberos/krb5kdc/kadm5.keytab
ktutil:  l
slot KVNO Principal
---- ---- ---------------------------------------------------------------------
   1    3                  kadmin/admin@EXAMPLE.COM
   2    3                  kadmin/admin@EXAMPLE.COM
   3    3               kadmin/changepw@EXAMPLE.COM
   4    3               kadmin/changepw@EXAMPLE.COM
ktutil: q
			</pre></div><div class="section" title="3.4.2. klist - list cached Kerberos tickets"><div class="titlepage"><div><div><h4 class="title"><a id="idp1050608"></a>3.4.2. klist - list cached Kerberos tickets</h4></div></div></div><pre class="screen">
[root@datacenter ~]# klist
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: admin/admin@EXAMPLE.COM

Valid starting     Expires            Service principal
03/25/10 16:53:02  03/26/10 16:53:02  krbtgt/EXAMPLE.COM@EXAMPLE.COM
03/25/10 17:02:10  03/26/10 16:53:02  host/172.16.0.8@


Kerberos 4 ticket cache: /tmp/tkt0
klist: You have no tickets cached
			</pre></div></div><div class="section" title="3.5. OpenSSH Authentications"><div class="titlepage"><div><div><h3 class="title"><a id="kerberos.openssh"></a>3.5. OpenSSH Authentications</h3></div></div></div><div class="section" title="3.5.1. Configuring the Application server system"><div class="titlepage"><div><div><h4 class="title"><a id="idp1052560"></a>3.5.1. Configuring the Application server system</h4></div></div></div><pre class="screen">
[root@datacenter ~]# kinit   admin/admin
Password for admin/admin@EXAMPLE.COM:

[root@datacenter ~]# kadmin.local -q "addprinc -randkey host/172.16.0.8"
Authenticating as principal admin/admin@EXAMPLE.COM with password.
WARNING: no policy specified for host/172.16.0.8@EXAMPLE.COM; defaulting to no policy
Principal "host/172.16.0.8@EXAMPLE.COM" created.

[root@datacenter ~]# kadmin.local -q " ktadd -k /var/kerberos/krb5kdc/kadm5.keytab host/172.16.0.8"
Authenticating as principal admin/admin@EXAMPLE.COM with password.
Entry for principal host/172.16.0.8 with kvno 3, encryption type Triple DES cbc mode with HMAC/sha1 added to keytab WRFILE:/var/kerberos/krb5kdc/kadm5.keytab.
Entry for principal host/172.16.0.8 with kvno 3, encryption type DES cbc mode with CRC-32 added to keytab WRFILE:/var/kerberos/krb5kdc/kadm5.keytab.
[root@datacenter ~]# ktutil
ktutil:  rkt /var/kerberos/krb5kdc/kadm5.keytab
ktutil:  l
slot KVNO Principal
---- ---- ---------------------------------------------------------------------
   1    3                  kadmin/admin@EXAMPLE.COM
   2    3                  kadmin/admin@EXAMPLE.COM
   3    3               kadmin/changepw@EXAMPLE.COM
   4    3               kadmin/changepw@EXAMPLE.COM
   5    3               host/172.16.0.8@EXAMPLE.COM
   6    3               host/172.16.0.8@EXAMPLE.COM
ktutil:  q
[root@datacenter ~]#
			</pre></div><div class="section" title="3.5.2. Configuring the Application client system"><div class="titlepage"><div><div><h4 class="title"><a id="idp1054976"></a>3.5.2. Configuring the Application client system</h4></div></div></div><p>/etc/ssh/sshd_config</p><pre class="screen">
KerberosAuthentication yes
			</pre></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="network.authentication.ldap.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="network.authentication.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="freeradius.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">2. OpenLDAP </td><td width="20%" align="center"><a accesskey="h" href="../index.html">起始页</a></td><td width="40%" align="right" valign="top"> 4. FreeRADIUS (Remote Authentication Dial In User Service)</td></tr></table></div></body></html>

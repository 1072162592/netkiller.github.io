<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>2. Squid - Internet Object Cache (WWW proxy cache)</title><link rel="stylesheet" href="docbook.css" type="text/css" /><meta name="generator" content="DocBook XSL Stylesheets V1.75.2" /><link rel="home" href="../index.html" title="Netkiller Linux 手札" /><link rel="up" href="proxy.html" title="第 37 章 Proxy Server" /><link rel="prev" href="proxy.html" title="第 37 章 Proxy Server" /><link rel="next" href="ch37s03.html" title="3. Web page proxy" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">2. Squid - Internet Object Cache (WWW proxy cache)</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="proxy.html">上一页</a> </td><th width="60%" align="center">第 37 章 Proxy Server</th><td width="20%" align="right"> <a accesskey="n" href="ch37s03.html">下一页</a></td></tr></table><hr /><table width="100%" border="0"><tr><td align="left"><a href="http://netkiller.sourceforge.net/">Home</a> | 
		<a href="http://netkiller.github.com/">Mirror</a> |		
		<a href="/search.html">Search</a></td><td align="right"><form id="searchbox_008589143145807374698:f5uprauilyy" action="/search.html"><input type="hidden" name="cx" value="008589143145807374698:f5uprauilyy" /><input type="hidden" name="cof" value="FORID:11" /><input name="q" type="text" size="25" style="border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(126, 157, 185); border-right-color: rgb(126, 157, 185); border-bottom-color: rgb(126, 157, 185); border-left-color: rgb(126, 157, 185); padding-top: 2px; padding-right: 2px; padding-bottom: 2px; padding-left: 2px; background-image: url(http://www.google.com/cse/intl/en/images/google_custom_search_watermark.gif); background-attachment: initial; background-origin: initial; background-clip: initial; background-color: rgb(255, 255, 255); background-position: 0% 50%; background-repeat: no-repeat no-repeat; " /><input type="submit" name="sa" value="Search" /><input name="siteurl" type="hidden" value="http://netkiller.sourceforge.net/" /></form><script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=searchbox_008589143145807374698%3Af5uprauilyy"></script></td></tr></table></div><div class="section" title="2. Squid - Internet Object Cache (WWW proxy cache)"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="squid"></a>2. Squid - Internet Object Cache (WWW proxy cache)</h2></div></div></div><p>如果apache 安装了gzip,deflate需要开启cache_vary</p><p>cache_vary on</p><div class="section" title="2.1. 源码安装"><div class="titlepage"><div><div><h3 class="title"><a id="squid.source"></a>2.1. 源码安装</h3></div></div></div><pre class="screen">
wget http://www.squid-cache.org/Versions/v2/2.6/squid-2.6.STABLE13.tar.gz
./configure --prefix=/usr/local/squid-2.6
make all
make install

mkdir -p /usr/local/squid-2.6/var/cache
chown nobody.nobody -R /usr/local/squid-2.6/var/
ln -s /usr/local/squid-2.6 /usr/local/squid
cd /usr/local/squid

./squid -NCd1
		</pre></div><div class="section" title="2.2. debian/ubuntu 安装"><div class="titlepage"><div><div><h3 class="title"><a id="squid.debian"></a>2.2. debian/ubuntu 安装</h3></div></div></div><span class="command"><strong>$ sudo apt-get install squid</strong></span><pre class="screen">
$ sudo apt-get install squid3
$ sudo apt-get install squidclient
			</pre></div><div class="section" title="2.3. 配置"><div class="titlepage"><div><div><h3 class="title"><a id="squid.config"></a>2.3. 配置</h3></div></div></div><p>查看当前配置参数</p><p>当你打开squid.conf文件时，你会头大，因为文件太长了，并且已经启用了部分参数。你可以使用下面命令查看那些参数被开启。</p><pre class="screen">
$ grep '^[a-z]' squid.conf		
		</pre><p>下面是安装squid3后的默认开启选项</p><pre class="screen">
$ grep '^[a-z]' squid.conf
acl manager proto cache_object
acl localhost src 127.0.0.1/32
acl to_localhost dst 127.0.0.0/8
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl CONNECT method CONNECT
http_access allow manager localhost
http_access deny manager
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost
http_access deny all
icp_access deny all
htcp_access deny all
http_port 3128
hierarchy_stoplist cgi-bin ?
access_log /var/log/squid3/access.log squid
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern (cgi-bin|\?)    0       0%      0
refresh_pattern .               0       20%     4320
icp_port 3130
coredump_dir /var/spool/squid3		
		</pre><p>修改squid.conf之前请做好备份。</p><pre class="screen">
netkiller@Linux-server:/etc/squid$ sudo cp squid.conf squid.conf.old
netkiller@Linux-server:/etc/squid$ sudo vi squid.conf
		</pre><p>生成自己的squid.conf文件,这样比较清晰</p><pre class="screen">
$ grep '^[a-z]' squid.conf.old &gt; squid.conf		
		</pre><div class="section" title="2.3.1. 代理服务器"><div class="titlepage"><div><div><h4 class="title"><a id="id1498755"></a>2.3.1. 代理服务器</h4></div></div></div><p>加入权限认证</p><pre class="screen">
netkiller@Linux-server:/etc/squid$ sudo htpasswd -c /etc/squid/squid_passwd neo
New password:
Re-type new password:
Adding password for user neo
netkiller@Linux-server:/etc/squid$


netkiller@Linux-server:/etc/squid$ sudo find / -name ncsa_auth
/usr/lib/squid/ncsa_auth

#
# Add this to the auth_param section of squid.conf
#
auth_param basic program /usr/lib/squid/ncsa_auth /etc/squid/squid_passwd

#
# Add this to the bottom of the ACL section of squid.conf
#
acl ncsa_users proxy_auth REQUIRED
acl business_hours time M T W H F 9:00-17:00

#
# Add this at the top of the http_access section of squid.conf
#
http_access allow ncsa_users business_hours

			</pre><p>extension_methods REPORT MERGE MKACTIVITY CHECKOUT # subversion</p><pre class="screen">
extension_methods REPORT MERGE MKACTIVITY CHECKOUT			
			</pre><p>默认端口 3128 如果你不想改squid.conf,可以使用iptables映射</p><span class="command"><strong>iptables -t nat -A PREROUTING -i eth0 -p tcp -s 0.0.0.0/0.0.0.0 --dport 80 -j REDIRECT --to-ports 3128 </strong></span><p>设置你的浏览器，并测试</p></div><div class="section" title="2.3.2. Squid作为反向代理Cache服务器(Reverse Proxy)"><div class="titlepage"><div><div><h4 class="title"><a id="id1498791"></a>2.3.2. Squid作为反向代理Cache服务器(Reverse Proxy)</h4></div></div></div><p>这里我们将apache和squid安装在一台服务器上</p><div class="procedure" title="过程 37.1. 配置步骤"><a id="id1498797"></a><p class="title"><b>过程 37.1. 配置步骤</b></p><ol class="procedure" type="1"><li class="step" title="步骤 1"><p>配置Apache监听端口</p><pre class="screen">
netkiller@Linux-server:~$ cd /etc/apache2/
netkiller@Linux-server:/etc/apache2$ sudo cp ports.conf ports.conf.old
netkiller@Linux-server:/etc/apache2$ sudo vi ports.conf
Listen 8080
Listen 443
netkiller@Linux-server:/etc/apache2$ sudo /etc/init.d/apache2 restart
 * Forcing reload of apache 2.0 web server...                                                                                          [ ok ]
netkiller@Linux-server:/etc/apache2$
					</pre><p>restart/reload后测试一下</p><p>http://localhost:8080/</p></li><li class="step" title="步骤 2"><p>squid 2.5 之前的版本</p><pre class="screen">
netkiller@Linux-server:/etc/apache2$ cd ../squid/
netkiller@Linux-server:/etc/squid$ sudo vi squid.conf
http_port 80
httpd_accel_host localhost
httpd_accel_port 8080
httpd_accel_single_host on
httpd_accel_with_proxy on
httpd_accel_uses_host_header off
netkiller@Linux-server:/etc/squid$ sudo /etc/init.d/squid reload
 * Reloading Squid configuration files
   ...done.
netkiller@Linux-server:/etc/squid$
					</pre><p>squid 2.5 之前的版本</p><p>对公网主机220.201.35.11:80做Cache</p><pre class="screen">
netkiller@Linux-server:/etc/apache2$ cd ../squid/
netkiller@Linux-server:/etc/squid$ sudo vi squid.conf
http_port 80
httpd_accel_host 220.201.35.11
httpd_accel_port 80
httpd_accel_single_host on
httpd_accel_with_proxy on
httpd_accel_uses_host_header off
netkiller@Linux-server:/etc/squid$ sudo /etc/init.d/squid reload
 * Reloading Squid configuration files
   ...done.
netkiller@Linux-server:/etc/squid$
					</pre><p>多台主机做Cache</p><pre class="screen">
netkiller@Linux-server:/etc/apache2$ cd ../squid/
netkiller@Linux-server:/etc/squid$ sudo vi squid.conf
http_port 80
httpd_accel_host virtual
httpd_accel_port 8080
httpd_accel_single_host on
httpd_accel_with_proxy on
httpd_accel_uses_host_header off
netkiller@Linux-server:/etc/squid$ sudo /etc/init.d/squid reload
 * Reloading Squid configuration files
   ...done.
netkiller@Linux-server:/etc/squid$
					</pre></li><li class="step" title="步骤 3"><p>squid 2.6之后版本的配置</p><p>localhost</p><pre class="screen">
http_port 80 defaultsite=localhost vhost transparent
cache_peer localhost parent 8080 0 no-query originserver
					</pre><p>其它主机</p><pre class="screen">
http_port 80 defaultsite=192.168.1.2 vhost transparent
cache_peer 192.168.1.2 parent 80 0 no-query originserver
					</pre></li><li class="step" title="步骤 4"><p>2.7/3.0 版本</p><pre class="screen">
visible_hostname netkiller.8800.org

http_port 80 accel vhost vport

cache_peer 127.0.0.1 parent 8080 0 no-query originserver name=mainsite
cache_peer 127.0.0.1 parent 8080 0 no-query originserver name=site1
cache_peer_domain mainsite netkiller.8800.org
cache_peer_domain site1 neo.ohyeap.com
http_access allow all
				
					</pre></li><li class="step" title="步骤 5"><p>注意事项</p><p>ERROR</p><p>The requested URL could not be retrieved</p><p>* Access Denied</p><p>出现上面错说，关闭http_access deny all</p><p># And finally deny all other access to this proxy</p><p>#http_access deny all</p></li></ol></div><pre class="screen">
#squid.conf
#服务器IP 192.168.1.1
#监听服务器的80端口，透明代理，支持域名和IP的虚拟主机
http_port 192.168.1.1:80 transparent vhost vport

#限制同一IP客户端的最大连接数
acl OverConnLimit maxconn 16
http_access deny OverConnLimit

#防止天涯盗链，转嫁给百度
acl tianya referer_regex -i tianya
http_access deny tianya
deny_info http://www.baidu.com/logs.gif tianya

#防止被人利用为HTTP代理，设置允许访问的IP地址
acl myip dst 192.168.1.1
http_access deny !myip

#防止百度机器人爬死服务器
acl AntiBaidu req_header User-Agent Baiduspider
http_access deny AntiBaidu

#允许本地管理
acl Manager proto cache_object
acl Localhost src 127.0.0.1 192.168.1.1
http_access allow Manager Localhost
http_access deny Manager

#仅仅允许80端口的代理
acl Safe_ports port 80 # http
http_access deny !Safe_ports
http_access allow all

#Squid信息设置
visible_hostname netkiller.8800.org
cache_mgr openunix@163.com

#基本设置
cache_effective_user squid
cache_effective_group squid
tcp_recv_bufsize 65535 bytes

#2.5的反向代理加速配置
#httpd_accel_host 127.0.0.1
#httpd_accel_port 80
#httpd_accel_single_host on
#httpd_accel_uses_host_header on
#httpd_accel_with_proxy on
#2.6的反向代理加速配置
#代理到本机的80端口的服务，仅仅做为原始内容服务器
cache_peer 127.0.0.1 parent 80 0 no-query originserver

#错误文档
error_directory /usr/local/squid/share/errors/Simplify_Chinese

#单台使用，不使用该功能
icp_port 0
			</pre></div><div class="section" title="2.3.3. 代理+反向代理"><div class="titlepage"><div><div><h4 class="title"><a id="id1498932"></a>2.3.3. 代理+反向代理</h4></div></div></div><pre class="screen">
http_port 80 vhost vport defaultsite=220.201.35.11
http_port 88
......
......
acl Manager proto cache_object
acl Localhost src 127.0.0.1/32
acl Safe_ports port 80
acl all src 0.0.0.0/0.0.0.0
acl ACCEL_DST dst 127.0.0.1/32 220.201.35.11/32

acl ACCEL_MODE  myport 80
acl PROXY_MODE  myport 88
# Authentation
auth_param basic realm Please Login
auth_param basic program /usr/local/squid/libexec/ncsa_auth /usr/local/squid/etc/passwd
acl VALIDUSER proxy_auth plan9

# ACCEL MODE
# -----------------------------------------------------------------------------
cache_peer 10.34.2.93 parent 80 0 no-query originserver
cache_peer_access 220.201.35.11 allow ACCEL_MODE
cache_peer_access 220.201.35.11 deny all

http_access allow ACCEL_DST Safe_ports
http_access allow PROXY_MODE VALIDUSER
http_access deny !Safe_ports
http_access allow ACCEL_MODE
http_access allow Manager Localhost
http_access deny all
icp_access deny all
			</pre></div></div><div class="section" title="2.4. Squid 管理"><div class="titlepage"><div><div><h3 class="title"><a id="squid.manager"></a>2.4. Squid 管理</h3></div></div></div><div class="section" title="2.4.1. squidclient"><div class="titlepage"><div><div><h4 class="title"><a id="id1498951"></a>2.4.1. squidclient</h4></div></div></div><p>squidclient -- client interface to the squid cache</p><div class="orderedlist" title="squidclient 使用方法"><p class="title"><b>squidclient 使用方法</b></p><ol class="orderedlist" type="1"><li class="listitem">运行状态信息： squidclient -p 80 mgr:info</li><li class="listitem">内存使用情况： squidclient -p 80 mgr:mem</li><li class="listitem">磁盘使用情况： squidclient -p 80 mgr:diskd</li><li class="listitem">已经缓存的列表： squidclient -p 80 mgr:objects. use it carefully,it may crash</li><li class="listitem">强制更新url：squidclient -p 80 -m PURGE http://netkiller.8800.org/index.html</li><li class="listitem">查看更多信息：squidclient -h 或者 squidclient -p 80 mgr:</li></ol></div><pre class="screen">
debian:~# squidclient -p 80 mgr:squidaio_counts
HTTP/1.0 200 OK
Server: squid/2.6.STABLE5
Date: Sun, 29 Apr 2007 13:27:09 GMT
Content-Type: text/plain
Expires: Sun, 29 Apr 2007 13:27:09 GMT
Last-Modified: Sun, 29 Apr 2007 13:27:09 GMT
X-Cache: MISS from debian.example.org.example.org
X-Cache-Lookup: MISS from debian.example.org.example.org:80
Via: 1.0 debian.example.org.example.org:80 (squid/2.6.STABLE5)
Connection: close

ASYNC IO Counters:
Operation       # Requests
open    0
close   0
cancel  0
write   0
read    0
stat    0
unlink  0
check_callback  0
queue   0
debian:~#

			</pre><p>squidclient -p 80 mgr:5min</p></div><div class="section" title="2.4.2. reset cache"><div class="titlepage"><div><div><h4 class="title"><a id="id1498994"></a>2.4.2. reset cache</h4></div></div></div><p>重做 cache</p><pre class="screen">
mkdir /var/spool/squid		
chown proxy.proxy -R /var/spool/squid		
netkiller@Linux-server:~$ sudo squid -z
netkiller@Linux-server:~$ sudo squid -k reconfigure
			</pre></div></div><div class="section" title="2.5. 禁止页面被Cache"><div class="titlepage"><div><div><h3 class="title"><a id="id1499006"></a>2.5. 禁止页面被Cache</h3></div></div></div><p>加到head中</p><pre class="screen">
		
  HTML
          &lt;META   HTTP-EQUIV="pragma" CONTENT="no-cache"&gt;
          &lt;META   HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate"&gt;
          &lt;META   HTTP-EQUIV="expires" CONTENT="Wed, 26 Feb 1978 08:21:57 GMT"&gt;
  ASP
  &lt;%
          Response.Expires = -1
          Response.ExpiresAbsolute = Now() - 1
          Response.cachecontrol = "no-cache"
  %&gt;
  PHP
          header("Expires: Mon, 26 Jul 1997 05:00:00 GMT");
          header("Cache-Control: no-cache, must-revalidate");
          header("Pragma: no-cache");
  JSP
          response.setHeader("Pragma","No-Cache");
          response.setHeader("Cache-Control","No-Cache");
          response.setDateHeader("Expires",   0);
  C#中禁止cache的方法！
          Response.Buffer=true;
          Response.ExpiresAbsolute=System.DateTime.Now.AddSeconds(-1);
          Response.Expires=0;
          Response.CacheControl="no-cache";
		
		</pre><p>让浏览器发送no-cache头,只需Ctrl+f5刷新</p></div><div class="section" title="2.6. Squid 实用案例"><div class="titlepage"><div><div><h3 class="title"><a id="id1499026"></a>2.6. Squid 实用案例</h3></div></div></div><div class="section" title="2.6.1. Squid Apache/Lighttpd 在同一台服务器上"><div class="titlepage"><div><div><h4 class="title"><a id="id1499029"></a>2.6.1. Squid Apache/Lighttpd 在同一台服务器上</h4></div></div></div><p>squid 与 web server 在同一台服务器上,一般情况是squid 监听80端口, web server 监听其它端口(一般是8080)</p><p>用户访问时通过80端口访问服务器.不想让用户访问8080.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>web server</p><p>Apache httpd.conf文件Listen 8080 改成IP:Port,这样8080端口只允许本地访问</p><pre class="screen">
Listen 127.0.0.1:8080
					</pre><p>lighttpd</p><pre class="screen">
vi /etc/lighttpd/lighttpd.conf
server.port               = 8080
server.bind               = "localhost"

/etc/init.d/lighttpd reload
					</pre><p>本地测试</p><pre class="screen">
curl http://127.0.0.1:8080/
					</pre></li><li class="listitem"><p>Squid</p><pre class="screen">
http_port 80 defaultsite=localhost vhost
cache_peer localhost parent 8080 0 no-query originserver

acl our_networks src 172.16.0.0/16
http_access allow our_networks
http_access allow all
					</pre><p>测试</p><pre class="screen">
curl http://127.0.0.1/
					</pre><p>在其它电脑上用IE访问http://your_ip/ 可以看到你的主页</p><p>在其它电脑上用IE访问 http://ip:8080/ 应该是无法访问</p></li><li class="listitem"><p>另一种方法是使用 iptables 实现</p><pre class="screen">
/sbin/iptables -A INPUT -i eth0 -p tcp --dport 8080 -j DROP
/sbin/iptables -A INPUT -i lo -p tcp --dport 8080 -j ACCEPT
					</pre></li></ol></div><p>使用 nmap 工具还是可以看到8080存在的.</p><span class="command"><strong># nmap localhost</strong></span><pre class="screen">
debian:~# nmap localhost

Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2007-04-29 08:28 EDT
Interesting ports on localhost (127.0.0.1):
Not shown: 1670 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
25/tcp   open  smtp
53/tcp   open  domain
80/tcp   open  http
111/tcp  open  rpcbind
113/tcp  open  auth
548/tcp  open  afpovertcp
901/tcp  open  samba-swat
953/tcp  open  rndc
8080/tcp open  http-proxy

Nmap finished: 1 IP address (1 host up) scanned in 0.268 seconds
			</pre></div><div class="section" title="2.6.2. 用非 root 用户守护 Squid"><div class="titlepage"><div><div><h4 class="title"><a id="id1499123"></a>2.6.2. 用非 root 用户守护 Squid</h4></div></div></div><p>squid.conf</p><pre class="screen">
http_port 3128 transparent vhost vport
			</pre><p>iptables 做端口重定向</p><pre class="screen">
iptables -t nat -A PREROUTING -j REDIRECT -p tcp --destination-port 80 --to-ports 3128
			</pre></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="proxy.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="proxy.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="ch37s03.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">第 37 章 Proxy Server </td><td width="20%" align="center"><a accesskey="h" href="../index.html">起始页</a></td><td width="40%" align="right" valign="top"> 3. Web page proxy</td></tr></table></div><script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script><script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-2033740-1");
pageTracker._trackPageview();
} catch(err) {}</script></body></html>

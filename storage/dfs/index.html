<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>第 6 章 Distributed File Systems</title><link rel="stylesheet" type="text/css" href="..//docbook.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><meta name="keywords" content="openfiler, freenas, proftpd,pureftpd,vsftpd, rsync,wget,samba" /><link rel="home" href="../index.html" title="Netkiller Linux Storage 手札" /><link rel="up" href="../index.html" title="Netkiller Linux Storage 手札" /><link rel="prev" href="../share/samba.html" title="5.3. Samba" /><link rel="next" href="nbd.html" title="6.2. Network Block Device protocol" /></head><body><a xmlns="" href="http://www.netkiller.cn/">Home</a> |
		<a xmlns="" href="http://netkiller.github.io/">简体中文</a> |
	    <a xmlns="" href="http://netkiller.sourceforge.net/">繁体中文</a> |
	    <a xmlns="" href="/journal/index.html">杂文</a> |
	    <a xmlns="" href="/search.html">Search</a> |
	    <a xmlns="" href="http://netkiller-github-com.iteye.com/">ITEYE 博客</a> |
	    <a xmlns="" href="http://my.oschina.net/neochen/">OSChina 博客</a> |
	    <a xmlns="" href="https://www.facebook.com/bg7nyt">Facebook</a> |
	    <a xmlns="" href="http://cn.linkedin.com/in/netkiller/">Linkedin</a> |
		<a xmlns="" href="mailto:netkiller@msn.com">Email</a><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第 6 章 Distributed File Systems</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="../share/samba.html">上一页</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="nbd.html">下一页</a></td></tr></table><hr /></div><table xmlns=""><tr><td><iframe src="http://ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.com&amp;type=watch&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="http://ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.com&amp;type=fork&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="http://ghbtns.com/github-btn.html?user=netkiller&amp;type=follow&amp;count=true&amp;size=large" height="30" width="240" frameborder="0" scrolling="0" style="width:240px; height: 30px;" allowTransparency="true"></iframe></td></tr></table><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="index"></a>第 6 章 Distributed File Systems</h1></div></div></div><div class="toc"><p><strong>目录</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#drbd">6.1. DRBD (Distributed Replicated Block Device)</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#idm44819962706176">6.1.1. disk and partition</a></span></dt><dt><span class="section"><a href="index.html#idm44819962706048">6.1.2. Installation</a></span></dt><dt><span class="section"><a href="index.html#idm44819962697712">6.1.3. configure</a></span></dt><dt><span class="section"><a href="index.html#idm44819962695456">6.1.4. Starting</a></span></dt><dt><span class="section"><a href="index.html#idm44819962690960">6.1.5. Using</a></span></dt></dl></dd><dt><span class="section"><a href="nbd.html">6.2. Network Block Device protocol</a></span></dt><dd><dl><dt><span class="section"><a href="nbd.html#idm44819962687872">6.2.1. nbd-server - Network Block Device protocol - server</a></span></dt><dt><span class="section"><a href="nbd.html#idm44819962686816">6.2.2. nbd-client - Network Block Device protocol - client</a></span></dt></dl></dd><dt><span class="section"><a href="gridfs.html">6.3. GridFS</a></span></dt><dd><dl><dt><span class="section"><a href="gridfs.html#nginx-gridfs">6.3.1. nginx-gridfs</a></span></dt><dt><span class="section"><a href="gridfs.html#lighttpd-gridfs">6.3.2. lighttpd-gridfs</a></span></dt></dl></dd><dt><span class="section"><a href="moosefs.html">6.4. Moose File System</a></span></dt><dd><dl><dt><span class="section"><a href="moosefs.html#idm44819962675008">6.4.1. Master server installation</a></span></dt><dt><span class="section"><a href="moosefs.html#idm44819962670176">6.4.2. Backup server (metalogger) installation </a></span></dt><dt><span class="section"><a href="moosefs.html#idm44819962667552">6.4.3. Chunk servers installation</a></span></dt><dt><span class="section"><a href="moosefs.html#idm44819962663520">6.4.4. Users’ computers installation</a></span></dt><dt><span class="section"><a href="moosefs.html#idm44819962660960">6.4.5. Testing MFS</a></span></dt></dl></dd><dt><span class="section"><a href="hdfs.html">6.5. Hadoop - HDFS</a></span></dt><dd><dl><dt><span class="section"><a href="hdfs.html#idm44819962656720">6.5.1. 单机安装</a></span></dt><dt><span class="section"><a href="hdfs.html#idm44819962643712">6.5.2. 分布式安装</a></span></dt><dd><dl><dt><span class="section"><a href="hdfs.html#idm44819962642832">6.5.2.1. 准备工作</a></span></dt><dt><span class="section"><a href="hdfs.html#idm44819962629552">6.5.2.2. NameNode 配置名称节点</a></span></dt><dt><span class="section"><a href="hdfs.html#idm44819962612368">6.5.2.3. DataNode 配置数据节点</a></span></dt><dt><span class="section"><a href="hdfs.html#idm44819962609872">6.5.2.4. Hadoop UI (WEB界面)</a></span></dt><dt><span class="section"><a href="hdfs.html#idm44819962608848">6.5.2.5. 测试Hadoop</a></span></dt></dl></dd><dt><span class="section"><a href="hdfs.html#idm44819962606368">6.5.3. 二进制包安装</a></span></dt><dd><dl><dt><span class="section"><a href="hdfs.html#hdfs.jre">6.5.3.1. 安装 JRE</a></span></dt><dt><span class="section"><a href="hdfs.html#idm44819962604288">6.5.3.2. 安装 Hadoop</a></span></dt><dt><span class="section"><a href="hdfs.html#idm44819962602784">6.5.3.3. 创建用户</a></span></dt></dl></dd><dt><span class="section"><a href="hdfs.html#idm44819962601328">6.5.4. FAQ</a></span></dt><dd><dl><dt><span class="section"><a href="hdfs.html#idm44819962600944">6.5.4.1. hadoop-1.1.2-1.x86_64.rpm 包含哪些文件内容</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="ceph.html">6.6. Ceph</a></span></dt><dd><dl><dt><span class="section"><a href="ceph.html#idm44819962577680">6.6.1. Installation on Ubuntu</a></span></dt><dt><span class="section"><a href="ceph.html#idm44819962577552">6.6.2. Installation on CentOS</a></span></dt><dd><dl><dt><span class="section"><a href="ceph.html#idm44819962563344">6.6.2.1. mon</a></span></dt><dt><span class="section"><a href="ceph.html#idm44819962559456">6.6.2.2. mds</a></span></dt><dt><span class="section"><a href="ceph.html#idm44819962558592">6.6.2.3. osd</a></span></dt><dt><span class="section"><a href="ceph.html#idm44819962557728">6.6.2.4. client</a></span></dt><dt><span class="section"><a href="ceph.html#radosgw">6.6.2.5. RADOS Gateway</a></span></dt></dl></dd><dt><span class="section"><a href="ceph.html#ceph.blockdevices">6.6.3. Block Devices</a></span></dt></dl></dd><dt><span class="section"><a href="gluster.html">6.7. GlusterFS</a></span></dt><dd><dl><dt><span class="section"><a href="gluster.html#idm44819962552272">6.7.1. glusterfs-server</a></span></dt><dt><span class="section"><a href="gluster.html#idm44819962548752">6.7.2. glusterfs-client</a></span></dt><dt><span class="section"><a href="gluster.html#idm44819962544512">6.7.3. Testing</a></span></dt><dt><span class="section"><a href="gluster.html#gluster.raid">6.7.4. RAID</a></span></dt><dd><dl><dt><span class="section"><a href="gluster.html#idm44819962540944">6.7.4.1. Mirror</a></span></dt><dt><span class="section"><a href="gluster.html#idm44819962539488">6.7.4.2. Strip</a></span></dt></dl></dd><dt><span class="section"><a href="gluster.html#idm44819962538288">6.7.5. Filesystem Administration</a></span></dt><dt><span class="section"><a href="gluster.html#idm44819962536592">6.7.6. CentOS 6.3</a></span></dt></dl></dd><dt><span class="section"><a href="lustre.html">6.8. Lustre</a></span></dt><dt><span class="section"><a href="mogilefs.html">6.9. MogileFS</a></span></dt><dt><span class="section"><a href="kfs.html">6.10. Kosmos distributed file system (KFS)</a></span></dt><dt><span class="section"><a href="coda.html">6.11. Coda</a></span></dt><dt><span class="section"><a href="openafs.html">6.12. OpenAFS</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="drbd"></a>6.1. DRBD (Distributed Replicated Block Device)</h2></div></div></div><p>Homepage: http://www.drbd.org/</p><div><img src="images/storage/drbd.gif" /></div><div><img src="images/storage/drbd_ha.gif" /></div><p>实验环境需要两台电脑，如果你没有，建议你使用VMware，并且为每一个虚拟机添加两块硬盘。</p><div class="orderedlist"><p class="title"><strong>实验环境</strong></p><ol class="orderedlist" type="1"><li class="listitem"><p>master: 192.168.0.1 	DRBD:/dev/sdb </p></li><li class="listitem"><p>slave: 	192.168.0.2 	DRBD:/dev/sdb </p></li></ol></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm44819962706176"></a>6.1.1. disk and partition</h3></div></div></div><p>Each of the following steps must be completed on both nodes</p><p>show all of disk and partition</p><pre class="screen">
neo@master:~$ sudo sfdisk -s
/dev/sda:   8388608
/dev/sdb:   2097152
total: 10485760 blocks
			</pre><p>create a new partition on the disk /dev/sdb</p><pre class="screen">
$ sudo cfdisk /dev/sdb			
			</pre><p>you must have extended partition</p><p>check partition</p><pre class="screen">
neo@master:~$ sudo fdisk -l

Disk /dev/sda: 8589 MB, 8589934592 bytes
255 heads, 63 sectors/track, 1044 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Disk identifier: 0x000301bd

   Device Boot      Start         End      Blocks   Id  System
/dev/sda1   *           1         993     7976241   83  Linux
/dev/sda2             994        1044      409657+   5  Extended
/dev/sda5             994        1044      409626   82  Linux swap / Solaris

Disk /dev/sdb: 2147 MB, 2147483648 bytes
255 heads, 63 sectors/track, 261 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Disk identifier: 0x00000000

   Device Boot      Start         End      Blocks   Id  System
/dev/sdb1               1         261     2096451    5  Extended
/dev/sdb5               1         261     2096419+  83  Linux

			</pre><p>format /dev/sdb1</p><pre class="screen">
neo@master:~$ sudo mkfs.ext3 /dev/sdb1
			</pre><p>you also can using other file system</p><p>reiserfs</p><pre class="screen">
neo@master:~$ sudo mkfs.reiserfs /dev/sdb1		
			</pre><p>I suggest you using reiserfs.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm44819962706048"></a>6.1.2. Installation</h3></div></div></div><p>Each of the following steps must be completed on both nodes</p><p>search drbd8-utils package</p><pre class="screen">
neo@master:~$ apt-cache search drbd
drbd8-utils - RAID 1 over tcp/ip for Linux utilities
drbd0.7-module-source - RAID 1 over tcp/ip for Linux module source
drbd0.7-utils - RAID 1 over tcp/ip for Linux utilities
drbdlinks - Manages symlinks into a shared DRBD partition
			</pre><p>installation</p><pre class="screen">
neo@master:~$ sudo apt-get install drbd8-utils			
			</pre><p>to add modules from the Linux Kernel</p><pre class="screen">
neo@master:~$ sudo modprobe drbd
neo@master:~$ lsmod |grep drbd
drbd                  213000  0
cn                      9632  1 drbd
			
			</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm44819962697712"></a>6.1.3. configure</h3></div></div></div><p>Each of the following steps must be completed on both nodes</p><p>backup configure file</p><pre class="screen">
			
neo@master:~$ sudo cp /etc/drbd.conf /etc/drbd.conf.old
			
			</pre><p>edit /etc/drbd.conf</p><pre class="screen">
global { 
  usage-count yes; 
}
common {
  protocol C;
}
resource r0 {
  on master {
    device    /dev/drbd0;
    disk      /dev/sdb5;
    address   192.168.0.1:7789;
    meta-disk internal;
  }
  on slave {
    device    /dev/drbd0;
    disk      /dev/sdb5;
    address   10.1.1.32:7789;
    meta-disk internal;
  }
}
			</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm44819962695456"></a>6.1.4. Starting</h3></div></div></div><p>Each of the following steps must be completed on both nodes.</p><pre class="screen">
neo@master:~$ sudo drbdadm create-md r0	
neo@master:~$ sudo drbdadm attach r0
neo@master:~$ sudo drbdadm connect r0
neo@master:~$ sudo drbdadm -- --overwrite-data-of-peer primary r0

neo@slave:~$ sudo drbdadm create-md r0		
neo@slave:~$ sudo drbdadm attach r0
neo@slave:~$ sudo drbdadm connect r0

			</pre><p>master</p><pre class="screen">
			
neo@master:~$ sudo drbdadm create-md r0
v08 Magic number not found
md_offset 2146725888
al_offset 2146693120
bm_offset 2146627584

Found some data
 ==&gt; This might destroy existing data! &lt;==

Do you want to proceed?
[need to type 'yes' to confirm] yes

v07 Magic number not found
v07 Magic number not found
v08 Magic number not found
Writing meta data...
initialising activity log
NOT initialized bitmap
New drbd meta data block sucessfully created.
success
			
			</pre><p>slave</p><pre class="screen">
			
neo@slave:~# sudo drbdadm create-md r0
v08 Magic number not found
md_offset 2146725888
al_offset 2146693120
bm_offset 2146627584

Found some data
 ==&gt; This might destroy existing data! &lt;==

Do you want to proceed?
[need to type 'yes' to confirm] yes

v07 Magic number not found
v07 Magic number not found
v08 Magic number not found
Writing meta data...
initialising activity log
NOT initialized bitmap
New drbd meta data block sucessfully created.
success
			
			</pre><p>status</p><pre class="screen">
neo@master:~$ cat /proc/drbd
version: 8.0.11 (api:86/proto:86)
GIT-hash: b3fe2bdfd3b9f7c2f923186883eb9e2a0d3a5b1b build by phil@mescal, 2008-02-12 11:56:43
 0: cs:StandAlone st:Primary/Unknown ds:UpToDate/DUnknown   r---
    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0
        resync: used:0/31 hits:0 misses:0 starving:0 dirty:0 changed:0
        act_log: used:0/127 hits:0 misses:0 starving:0 dirty:0 changed:0
 1: cs:Connected st:Secondary/Secondary ds:Diskless/Inconsistent C r---
    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0
			
			</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm44819962690960"></a>6.1.5. Using</h3></div></div></div><p>master</p><pre class="screen">
neo@master:~$ sudo drbdadm primary all		
neo@master:~$ sudo mkfs.reiserfs /dev/drbd0
neo@master:~$ sudo mkdir /mnt/drbd0
neo@master:~$ sudo mount /dev/drbd0 /mnt/drbd0/
neo@master:~$ sudo touch /mnt/drbd0/helloworld.tmp
neo@master:~$ df -h
Filesystem            Size  Used Avail Use% Mounted on
/dev/sda1             7.6G  1.3G  6.0G  18% /
varrun                125M  216K  125M   1% /var/run
varlock               125M  8.0K  125M   1% /var/lock
udev                  125M   60K  125M   1% /dev
devshm                125M     0  125M   0% /dev/shm
/dev/drbd0            2.0G   33M  2.0G   2% /mnt/drbd0
neo@master:~$ sudo dd if=/dev/zero of=/mnt/drbd0/tempfile1.tmp bs=104857600 count=1
1+0 records in
1+0 records out
104857600 bytes (105 MB) copied, 0.564911 s, 186 MB/s
neo@master:~$ sudo umount /mnt/drbd0/
neo@master:~$ sudo drbdadm secondary all
			</pre><p>slave</p><pre class="screen">
neo@slave:~$ sudo drbdadm primary all			
neo@slave:~$ sudo mkdir /mnt/drbd0
neo@slave:~$ sudo mount /dev/drbd0 /mnt/drbd0/
neo@slave:~$ ls /mnt/drbd0/
helloworld.tmp  tempfile1.tmp			
			</pre></div></div></div><div xmlns="" id="disqus_thread"></div><script xmlns="" type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

            //if(document.domain == 'netkiller.github.com'){
            var disqus_shortname = 'netkiller'; // required: replace example with your forum shortname
            //}else{
			//var disqus_shortname = 'neochan';
            //}

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script><noscript xmlns="">Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a xmlns="" href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a><br xmlns="" /><script xmlns="" type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=r5HG&amp;d=9mi5r_kkDC8uxG8HuY3p4-2qgeeVypAK9vMD-2P6BYM"></script><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="../share/samba.html">上一页</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="nbd.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">5.3. Samba </td><td width="20%" align="center"><a accesskey="h" href="../index.html">起始页</a></td><td width="40%" align="right" valign="top"> 6.2. Network Block Device protocol</td></tr></table></div><script xmlns="">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-11694057-1', 'auto');
  ga('send', 'pageview');

</script><script xmlns="" type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F997cd4a7320a82d72cb74d179118f697' type='text/javascript'%3E%3C/script%3E"));
</script><script xmlns="" type="text/javascript" src="/js/q.js"></script></body></html>